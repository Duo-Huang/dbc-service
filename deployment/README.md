# éƒ¨ç½²é…ç½®

æœ¬ç›®å½•åŒ…å«è…¾è®¯äº‘ Web Function éƒ¨ç½²ç›¸å…³çš„é…ç½®å’Œè„šæœ¬ã€‚

**å®˜æ–¹æ–‡æ¡£**: [å¿«é€Ÿéƒ¨ç½² Nestjs æ¡†æ¶](https://cloud.tencent.com/document/product/1154/59341)

---

## ğŸ“ ç›®å½•ç»“æ„

```
deployment/
â”œâ”€â”€ README.md                   # éƒ¨ç½²æ–‡æ¡£ï¼ˆæœ¬æ–‡ä»¶ï¼‰
â”œâ”€â”€ ci-deploy.sh                # è‡ªåŠ¨æ‰“åŒ…è„šæœ¬
â”œâ”€â”€ console/                    # Console åº”ç”¨éƒ¨ç½²é…ç½®
â”‚   â””â”€â”€ scf_bootstrap          # Web Function å¯åŠ¨è„šæœ¬
â””â”€â”€ miniapp/                    # Miniapp åº”ç”¨éƒ¨ç½²é…ç½®
    â””â”€â”€ scf_bootstrap          # Web Function å¯åŠ¨è„šæœ¬
```

---

## ğŸš€ å¿«é€Ÿéƒ¨ç½²

### æ–¹å¼ä¸€ï¼šGitHub Actions è‡ªåŠ¨éƒ¨ç½²ï¼ˆæ¨èï¼‰

æ¨é€ä»£ç åˆ°æŒ‡å®šåˆ†æ”¯ï¼ŒGitHub Actions è‡ªåŠ¨è§¦å‘éƒ¨ç½²ï¼š

```bash
# æ¨é€åˆ° main åˆ†æ”¯ â†’ è‡ªåŠ¨æ„å»ºæ‰“åŒ…
git push origin main
```

CI æµç¨‹ä¼šè‡ªåŠ¨ï¼š

1. è¿è¡Œ Lint & Test
2. æ„å»ºé¡¹ç›®
3. å®‰è£…ç”Ÿäº§ä¾èµ–
4. å¤åˆ¶å¯åŠ¨è„šæœ¬
5. æ‰“åŒ…æˆ zip æ–‡ä»¶
6. ä¸Šä¼ ä¸º GitHub Artifacts

ç„¶åä» GitHub Actions ä¸‹è½½éƒ¨ç½²åŒ…ï¼Œä¸Šä¼ åˆ°è…¾è®¯äº‘æ§åˆ¶å°å³å¯ã€‚

### æ–¹å¼äºŒï¼šæœ¬åœ°æ‰“åŒ…

ä½¿ç”¨é¡¹ç›®æä¾›çš„æ‰“åŒ…è„šæœ¬ï¼š

```bash
# 1. æ„å»ºé¡¹ç›®
pnpm build

# 2. è¿è¡Œæ‰“åŒ…è„šæœ¬ï¼ˆä¼šè‡ªåŠ¨å®‰è£…ç”Ÿäº§ä¾èµ–ï¼‰
./deployment/ci-deploy.sh [app]

# å‚æ•°è¯´æ˜:
#   console - åªæ‰“åŒ… Console åº”ç”¨
#   miniapp - åªæ‰“åŒ… Miniapp åº”ç”¨
#   all     - æ‰“åŒ…æ‰€æœ‰åº”ç”¨ï¼ˆé»˜è®¤ï¼‰
```

**ç¤ºä¾‹ï¼š**

```bash
# åªæ‰“åŒ… Console åº”ç”¨
./deployment/ci-deploy.sh console

# åªæ‰“åŒ… Miniapp åº”ç”¨
./deployment/ci-deploy.sh miniapp

# æ‰“åŒ…æ‰€æœ‰åº”ç”¨
./deployment/ci-deploy.sh all
# æˆ–
./deployment/ci-deploy.sh
```

**è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆ**ï¼š

1. âœ… æ£€æŸ¥æ„å»ºäº§ç‰©æ˜¯å¦å­˜åœ¨
2. âœ… å¤åˆ¶ dist ç›®å½•
3. âœ… å¤åˆ¶ package.json å’Œ pnpm-lock.yaml
4. âœ… **è‡ªåŠ¨å®‰è£…ç”Ÿäº§ä¾èµ–**ï¼ˆ`pnpm install --prod --frozen-lockfile`ï¼‰
5. âœ… å¤åˆ¶ scf_bootstrap å¯åŠ¨è„šæœ¬
6. âœ… è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æƒé™ï¼ˆ`chmod +x`ï¼‰
7. âœ… æ‰“åŒ…æˆ zip æ–‡ä»¶

**ç”Ÿæˆçš„éƒ¨ç½²åŒ…**ï¼š

- `serverless_package/console.zip` - Console åº”ç”¨
- `serverless_package/miniapp.zip` - Miniapp åº”ç”¨

**æ³¨æ„**ï¼šæ— éœ€æ‰‹åŠ¨å®‰è£…ä¾èµ–ï¼Œè„šæœ¬ä¼šåœ¨ä¸´æ—¶ç›®å½•ä¸­è‡ªåŠ¨å¤„ç†ï¼Œä¸ä¼šå½±å“ä½ çš„å¼€å‘ç¯å¢ƒã€‚

### æ–¹å¼ä¸‰ï¼šè…¾è®¯äº‘æ§åˆ¶å°éƒ¨ç½²

1. è®¿é—® [Serverless åº”ç”¨ä¸­å¿ƒ](https://console.cloud.tencent.com/sls)
2. æ–°å»ºåº”ç”¨ â†’ **Web åº”ç”¨** â†’ **Nest.js æ¡†æ¶**
3. é€‰æ‹©ä¸Šä¼ æ–¹å¼ï¼š
    - **æœ¬åœ°ä¸Šä¼ **: ä¸Šä¼  zip åŒ…
    - **ä»£ç ä»“åº“**: è¿æ¥ GitHub/GitLab
4. æ§åˆ¶å°ä¼šè‡ªåŠ¨è¯†åˆ« `scf_bootstrap` å¯åŠ¨è„šæœ¬
5. å®Œæˆéƒ¨ç½²

---

## ğŸ“¦ éƒ¨ç½²åŒ…ç»“æ„

æ­£ç¡®çš„éƒ¨ç½²åŒ…åº”è¯¥åŒ…å«ï¼š

```
console.zip
â”œâ”€â”€ scf_bootstrap          # â† Web Function å¯åŠ¨è„šæœ¬ï¼ˆå¿…é¡»åœ¨æ ¹ç›®å½•ï¼‰
â”œâ”€â”€ dist/                  # â† æ„å»ºäº§ç‰©
â”‚   â””â”€â”€ apps/
â”‚       â””â”€â”€ console/
â”‚           â”œâ”€â”€ main.js
â”‚           â””â”€â”€ config/    # â† é…ç½®æ–‡ä»¶ï¼ˆwebpack è‡ªåŠ¨å¤åˆ¶ï¼‰
â”œâ”€â”€ node_modules/          # â† ä»…ç”Ÿäº§ä¾èµ–
â”œâ”€â”€ package.json
â””â”€â”€ pnpm-lock.yaml
```

**é‡è¦è¯´æ˜ï¼š**

1. âš ï¸ `scf_bootstrap` å¿…é¡»åœ¨ zip åŒ…çš„æ ¹ç›®å½•
2. âš ï¸ `node_modules` åªèƒ½åŒ…å«ç”Ÿäº§ä¾èµ–ï¼ˆä¸å« devDependenciesï¼‰
3. âš ï¸ `scf_bootstrap` å¿…é¡»æœ‰æ‰§è¡Œæƒé™ï¼ˆ777 æˆ– 755ï¼‰
4. âš ï¸ åº”ç”¨å¿…é¡»ç›‘å¬ `0.0.0.0:9000` ç«¯å£

---

## âš™ï¸ å¯åŠ¨è„šæœ¬é…ç½®

### scf_bootstrap

æ¯ä¸ªæœåŠ¡ç›®å½•ä¸‹éƒ½æœ‰ç‹¬ç«‹çš„ `scf_bootstrap` å¯åŠ¨è„šæœ¬ã€‚

**Console åº”ç”¨å¯åŠ¨è„šæœ¬** (`console/scf_bootstrap`)ï¼š

```bash
#!/bin/bash

# è®¾ç½®ç¯å¢ƒå˜é‡
export NODE_ENV=production
export SERVER_CONSOLE_PORT=9000

# å¯åŠ¨ NestJS åº”ç”¨
# ä½¿ç”¨äº‘å‡½æ•°æ ‡å‡† Node.js ç¯å¢ƒè·¯å¾„
SERVERLESS=1 /var/lang/node22.20.0/bin/node ./dist/apps/console/main.js
```

**Miniapp åº”ç”¨å¯åŠ¨è„šæœ¬** (`miniapp/scf_bootstrap`)ï¼š

```bash
#!/bin/bash

# è®¾ç½®ç¯å¢ƒå˜é‡
export NODE_ENV=production
export SERVER_MINIAPP_PORT=9000

# å¯åŠ¨ NestJS åº”ç”¨
SERVERLESS=1 /var/lang/node22.20.0/bin/node ./dist/apps/miniapp/main.js
```

**å…³é”®é…ç½®ï¼š**

- ç›‘å¬ç«¯å£ï¼š`9000`ï¼ˆWeb Function æ ‡å‡†ç«¯å£ï¼‰
- ç›‘å¬åœ°å€ï¼š`0.0.0.0`ï¼ˆåœ¨ä»£ç ä¸­é…ç½®ï¼‰
- Node.js è·¯å¾„ï¼š`/var/lang/node22.20.0/bin/node`ï¼ˆäº‘å‡½æ•°æ ‡å‡†è·¯å¾„ï¼‰

---

## ğŸ”§ ç¯å¢ƒå˜é‡

å¯ä»¥åœ¨å¯åŠ¨è„šæœ¬ä¸­è®¾ç½®ç¯å¢ƒå˜é‡ï¼š

| å˜é‡                  | è¯´æ˜         | é»˜è®¤å€¼     |
| --------------------- | ------------ | ---------- |
| `NODE_ENV`            | è¿è¡Œç¯å¢ƒ     | production |
| `SERVER_CONSOLE_PORT` | Console ç«¯å£ | 9000       |
| `SERVER_MINIAPP_PORT` | Miniapp ç«¯å£ | 9000       |

åœ¨ `scf_bootstrap` ä¸­æ·»åŠ ï¼š

```bash
export YOUR_ENV_VAR=value
```

æˆ–è€…åœ¨è…¾è®¯äº‘æ§åˆ¶å°çš„"ç¯å¢ƒå˜é‡"ä¸­é…ç½®ã€‚

---

## ğŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•

åœ¨éƒ¨ç½²å‰ï¼Œè¯·ç¡®è®¤ï¼š

- [ ] é¡¹ç›®å·²ç»æ„å»ºï¼š`pnpm build`
- [ ] `dist/` ç›®å½•å­˜åœ¨ä¸”åŒ…å«ç¼–è¯‘åçš„ä»£ç 
- [ ] `node_modules/` åªåŒ…å«ç”Ÿäº§ä¾èµ–
- [ ] `scf_bootstrap` æ–‡ä»¶å­˜åœ¨ä¸”æœ‰æ‰§è¡Œæƒé™
- [ ] åº”ç”¨ç›‘å¬ `0.0.0.0:9000` ç«¯å£
- [ ] é…ç½®æ–‡ä»¶å·²å¤åˆ¶åˆ° `dist/apps/*/config/`
- [ ] éƒ¨ç½²åŒ…å¤§å°åœ¨é™åˆ¶èŒƒå›´å†…ï¼ˆ< 500MB è§£å‹åï¼‰

---

## ğŸ› æ•…éšœæ’æŸ¥

### éƒ¨ç½²å¤±è´¥

1. æ£€æŸ¥éƒ¨ç½²åŒ…å¤§å°æ˜¯å¦è¶…è¿‡é™åˆ¶ï¼ˆ50MB å‹ç¼©åŒ… / 500MB è§£å‹åï¼‰
2. ç¡®è®¤ zip åŒ…ç»“æ„æ­£ç¡®
3. æŸ¥çœ‹è…¾è®¯äº‘æ§åˆ¶å°é”™è¯¯ä¿¡æ¯

### åº”ç”¨æ— æ³•å¯åŠ¨

1. æ£€æŸ¥ `scf_bootstrap` è„šæœ¬æƒé™ï¼ˆå¿…é¡»æ˜¯ 777 æˆ– 755ï¼‰
2. ç¡®è®¤ Node.js ç‰ˆæœ¬è·¯å¾„æ­£ç¡®ï¼ˆ`/var/lang/node22.20.0/bin/node`ï¼‰
3. æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®
4. æŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
5. ç¡®è®¤ `node_modules` å·²åŒ…å«åœ¨éƒ¨ç½²åŒ…ä¸­

### é…ç½®æœªç”Ÿæ•ˆ

1. ç¡®è®¤ `config/` ç›®å½•å·²åŒ…å«åœ¨ `dist/apps/*/` ä¸­
2. æ£€æŸ¥ `NODE_ENV` ç¯å¢ƒå˜é‡
3. éªŒè¯é…ç½®æ–‡ä»¶æ ¼å¼ï¼ˆYAMLï¼‰
4. æŸ¥çœ‹åº”ç”¨æ—¥å¿—

### æ¥å£ 404 é”™è¯¯

1. æ£€æŸ¥ API è·¯ç”±é…ç½®
2. ç¡®è®¤åº”ç”¨æ­£å¸¸å¯åŠ¨
3. æŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿—
4. æµ‹è¯•å¥åº·æ£€æŸ¥æ¥å£

---

## ğŸ’¡ æœ€ä½³å®è·µ

1. **ä½¿ç”¨ CI/CD**: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ä»…é€šè¿‡ CI/CDï¼Œé¿å…æ‰‹åŠ¨æ“ä½œ
2. **ç‹¬ç«‹éƒ¨ç½²**: Console å’Œ Miniapp å®Œå…¨ç‹¬ç«‹ï¼Œå¯å•ç‹¬éƒ¨ç½²å’Œå›æ»š
3. **ç‰ˆæœ¬ç®¡ç†**: ç»™éƒ¨ç½²åŒ…æ·»åŠ ç‰ˆæœ¬æ ‡ç­¾
4. **ç›‘æ§å‘Šè­¦**: é…ç½®äº‘å‡½æ•°ç›‘æ§å’Œæ—¥å¿—å‘Šè­¦
5. **ç°åº¦å‘å¸ƒ**: ä½¿ç”¨ API ç½‘å…³æµé‡ç®¡ç†åŠŸèƒ½
6. **æˆæœ¬ä¼˜åŒ–**: åˆç†é…ç½®å†…å­˜å’Œè¶…æ—¶æ—¶é—´

---

## âœ¨ Web Function éƒ¨ç½²ä¼˜åŠ¿

ç›¸æ¯”ä¼ ç»Ÿéƒ¨ç½²æ–¹å¼ï¼š

- âœ… **æ— éœ€æœåŠ¡å™¨** - é›¶è¿ç»´ï¼Œè‡ªåŠ¨æ‰©ç¼©å®¹
- âœ… **æ— éœ€é€‚é…å™¨** - ä¸éœ€è¦ `@vendia/serverless-express`
- âœ… **æ— éœ€æ¡†æ¶** - ä¸éœ€è¦ Serverless Framework
- âœ… **é…ç½®ç®€å•** - åªéœ€æ·»åŠ å¯åŠ¨è„šæœ¬
- âœ… **æˆæœ¬ä½å»‰** - æŒ‰é‡è®¡è´¹ï¼Œå°æµé‡å‡ ä¹å…è´¹

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [è…¾è®¯äº‘ Web Function å®˜æ–¹æ–‡æ¡£](https://cloud.tencent.com/document/product/1154/59341)
- [è…¾è®¯äº‘ Serverless åº”ç”¨ä¸­å¿ƒ](https://console.cloud.tencent.com/sls)
- [é¡¹ç›®éƒ¨ç½²æ€»ç»“](../docs/DEPLOYMENT_SUMMARY.md)
- [NestJS éƒ¨ç½²æ–‡æ¡£](https://docs.nestjs.com/deployment)

---

**ç¥éƒ¨ç½²é¡ºåˆ©ï¼** ğŸ‰
