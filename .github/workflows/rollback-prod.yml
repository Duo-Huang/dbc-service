name: å›æ»šç”Ÿäº§ç¯å¢ƒ

on:
    workflow_dispatch:
        inputs:
            confirm:
                description: 'ç¡®è®¤å›æ»šï¼ˆè¾“å…¥ ROLLBACKï¼‰'
                required: true
                type: string
            reason:
                description: 'å›æ»šåŸå› '
                required: true
                type: string

# å…¨å±€ç¯å¢ƒå˜é‡
env:
    NODE_VERSION: 20.19.5
    HUSKY: 0 # CI ç¯å¢ƒä¸­ç¦ç”¨ husky
    TENCENT_CONSOLE_URL: https://console.cloud.tencent.com/sls # è…¾è®¯äº‘æ§åˆ¶å° URL
    PROD_TAG: prod-latest # PROD ç¯å¢ƒéƒ¨ç½²æ ‡ç­¾
    PROD_PREV_TAG: prod-prev # PROD ä¸Šä¸€ç‰ˆæœ¬æ ‡ç­¾ï¼ˆç”¨äºå›æ»šï¼‰

# æƒé™é…ç½®ï¼ˆå…è®¸åˆ›å»ºå’Œæ¨é€ tagï¼‰
permissions:
    contents: write

# é˜²æ­¢å¹¶å‘éƒ¨ç½²
concurrency:
    group: deploy-prod
    cancel-in-progress: false

jobs:
    validate:
        name: éªŒè¯å›æ»šæ¡ä»¶
        runs-on: ubuntu-latest
        steps:
            - name: éªŒè¯ç¡®è®¤è¾“å…¥
              run: |
                  if [ "${{ inputs.confirm }}" != "ROLLBACK" ]; then
                      echo "âŒ ç¡®è®¤è¾“å…¥é”™è¯¯ï¼Œå¿…é¡»è¾“å…¥ 'ROLLBACK'"
                      exit 1
                  fi

            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: éªŒè¯å›æ»šæ¡ä»¶
              run: |
                  if ! git rev-parse ${{ env.PROD_PREV_TAG }} >/dev/null 2>&1; then
                      echo "âŒ ${{ env.PROD_PREV_TAG }} tag ä¸å­˜åœ¨"
                      echo "   åŸå› å¯èƒ½æ˜¯ï¼š"
                      echo "   1. è¿™æ˜¯é¦–æ¬¡éƒ¨ç½²"
                      echo "   2. å·²ç»å›æ»šè¿‡ä¸€æ¬¡"
                      exit 1
                  fi

                  CURRENT=$(git rev-parse ${{ env.PROD_TAG }})
                  TARGET=$(git rev-parse ${{ env.PROD_PREV_TAG }})

                  echo "âœ… å›æ»šæ¡ä»¶éªŒè¯é€šè¿‡"
                  echo "   å½“å‰ç‰ˆæœ¬: $CURRENT"
                  echo "   å›æ»šç›®æ ‡: $TARGET"
                  echo ""
                  echo "ğŸ“‹ å›æ»šåŸå› : ${{ inputs.reason }}"

    check-migration:
        name: æ£€æµ‹ Migration å˜æ›´
        runs-on: ubuntu-latest
        needs: [validate]
        outputs:
            needs_revert: ${{ steps.check.outputs.needs_revert }}
            new_migrations: ${{ steps.check.outputs.new_migrations }}
            revert_count: ${{ steps.check.outputs.revert_count }}
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: æ£€æµ‹ migration å·®å¼‚
              id: check
              run: |
                  chmod +x ./deployment/detect-migration-changes.sh
                  ./deployment/detect-migration-changes.sh ${{ env.PROD_PREV_TAG }} ${{ env.PROD_TAG }}

    # ====================================
    # å›é€€æ•°æ®åº“ï¼ˆå¦‚æœéœ€è¦ï¼‰
    # ====================================
    revert-migration:
        name: å›é€€æ•°æ®åº“
        runs-on: ubuntu-latest
        needs: [check-migration]
        if: needs.check-migration.outputs.needs_revert == 'true'
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4
              with:
                  ref: ${{ env.PROD_TAG }}

            - name: å®‰è£… pnpm
              uses: pnpm/action-setup@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: å›é€€ migrations
              run: |
                  REVERT_COUNT=${{ needs.check-migration.outputs.revert_count }}

                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                  echo "ğŸ—ƒï¸  å¼€å§‹å›é€€ migration"
                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                  echo "  éœ€è¦å›é€€: $REVERT_COUNT ä¸ª"
                  echo ""

                  SUCCESS_COUNT=0

                  for i in $(seq 1 $REVERT_COUNT); do
                      echo "[$i/$REVERT_COUNT] å›é€€ migration..."

                      if pnpm migration revert --prod; then
                          echo "   âœ… å›é€€æˆåŠŸ"
                          SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                      else
                          echo "   âŒ å›é€€å¤±è´¥"
                          echo ""
                          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                          echo "âŒ Migration å›é€€å¤±è´¥"
                          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                          echo "  æˆåŠŸ: $SUCCESS_COUNT"
                          echo "  å¤±è´¥: ç¬¬ $i ä¸ª"
                          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                          exit 1
                      fi
                      echo ""
                  done

                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                  echo "âœ… æ‰€æœ‰ migration å·²æˆåŠŸå›é€€"
                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                  echo "  æˆåŠŸå›é€€: $SUCCESS_COUNT ä¸ª"
                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              env:
                  MIGRATION_DB_HOST: ${{ secrets.PROD_MIGRATION_DB_HOST }}
                  MIGRATION_DB_PORT: ${{ secrets.PROD_MIGRATION_DB_PORT }}
                  MIGRATION_DB_NAME: ${{ secrets.PROD_MIGRATION_DB_NAME }}
                  MIGRATION_DB_SCHEMA: ${{ secrets.PROD_MIGRATION_DB_SCHEMA }}
                  MIGRATION_USER: ${{ secrets.PROD_MIGRATION_USER }}
                  MIGRATION_PASSWORD: ${{ secrets.PROD_MIGRATION_PASSWORD }}

    # ====================================
    # å›æ»šæœåŠ¡éƒ¨ç½²
    # ====================================
    rollback:
        name: å›æ»šæœåŠ¡
        runs-on: ubuntu-latest
        needs: [check-migration, revert-migration]
        if: |
            always() &&
            needs.check-migration.result == 'success' &&
            (needs.revert-migration.result == 'success' || needs.revert-migration.result == 'skipped')
        environment:
            name: prod
            url: ${{ env.TENCENT_CONSOLE_URL }}
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4
              with:
                  ref: ${{ env.PROD_PREV_TAG }} # ä»PRODç¯å¢ƒä¸Šä¸€ç‰ˆæœ¬å›æ»š
                  fetch-depth: 0 # éœ€è¦å®Œæ•´ git å†å²ï¼ˆç”¨äºæ›´æ–° tagsï¼‰

            - name: å®‰è£… pnpm
              uses: pnpm/action-setup@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: æ„å»ºé¡¹ç›®
              run: pnpm build

            - name: ç¡®ä¿ jq å·²å®‰è£…
              run: |
                  if ! command -v jq &> /dev/null; then
                      echo "å®‰è£… jq..."
                      sudo apt-get update && sudo apt-get install -y jq
                  else
                      echo "jq å·²å®‰è£…: $(jq --version)"
                  fi

            - name: å®‰è£… SCF CLI
              run: |
                  # pnpm/action-setup@v4 å·²è‡ªåŠ¨é…ç½® PNPM_HOMEï¼Œæ— éœ€ pnpm setup
                  pnpm add -g serverless-cloud-framework@1.3.2
                  scf --version

            - name: å›æ»šéƒ¨ç½²
              run: |
                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                  echo "ğŸš€ å¼€å§‹å›æ»šæœåŠ¡éƒ¨ç½²"
                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

                  chmod +x ./deployment/ci-deploy.sh

                  # å¼ºåˆ¶å…¨é‡éƒ¨ç½²ï¼ˆå›æ»šæ—¶ä¸ä¾èµ–å˜æ›´æ£€æµ‹ï¼‰
                  export LAYER_CHANGED=true
                  export CONSOLE_CHANGED=true
                  export MINIAPP_CHANGED=true

                  ./deployment/ci-deploy.sh

                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                  echo "âœ… æœåŠ¡å›æ»šéƒ¨ç½²å®Œæˆ"
                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              env:
                  STAGE: prod
                  SERVERLESS_PLATFORM_VENDOR: tencent # serverless å¢ƒå¤–é»˜è®¤ä¸º awsï¼Œé…ç½®ä¸ºè…¾è®¯
                  # è…¾è®¯äº‘å‡­è¯
                  TENCENT_SECRET_ID: ${{ secrets.PROD_TENCENT_SECRET_ID }}
                  TENCENT_SECRET_KEY: ${{ secrets.PROD_TENCENT_SECRET_KEY }}
                  # åŒºåŸŸé…ç½®
                  REGION: ap-chengdu
                  # Console åº”ç”¨æ•°æ®åº“é…ç½®
                  CONSOLE_DB_HOST: ${{ secrets.PROD_CONSOLE_DB_HOST }}
                  CONSOLE_DB_PORT: ${{ secrets.PROD_CONSOLE_DB_PORT }}
                  CONSOLE_DB_NAME: ${{ secrets.PROD_CONSOLE_DB_NAME }}
                  CONSOLE_DB_SCHEMA: ${{ secrets.PROD_CONSOLE_DB_SCHEMA }}
                  CONSOLE_DB_USER: ${{ secrets.PROD_CONSOLE_DB_USER }}
                  CONSOLE_DB_PASSWORD: ${{ secrets.PROD_CONSOLE_DB_PASSWORD }}
                  # Miniapp åº”ç”¨æ•°æ®åº“é…ç½®
                  MINIAPP_DB_HOST: ${{ secrets.PROD_MINIAPP_DB_HOST }}
                  MINIAPP_DB_PORT: ${{ secrets.PROD_MINIAPP_DB_PORT }}
                  MINIAPP_DB_NAME: ${{ secrets.PROD_MINIAPP_DB_NAME }}
                  MINIAPP_DB_SCHEMA: ${{ secrets.PROD_MINIAPP_DB_SCHEMA }}
                  MINIAPP_DB_USER: ${{ secrets.PROD_MINIAPP_DB_USER }}
                  MINIAPP_DB_PASSWORD: ${{ secrets.PROD_MINIAPP_DB_PASSWORD }}

            - name: æ›´æ–° tags
              run: |
                  ROLLBACK_COMMIT=$(git rev-parse ${{ env.PROD_PREV_TAG }})
                  ORIGINAL_COMMIT=$(git rev-parse ${{ env.PROD_TAG }})

                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                  echo "ğŸ·ï¸  æ›´æ–° tags"
                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

                  # æ›´æ–° prod-latest æŒ‡å‘ prod-prev
                  git tag -f ${{ env.PROD_TAG }} -m "ğŸ”™ Rolled back from production

                  Original version: $ORIGINAL_COMMIT
                  Rolled back to: $ROLLBACK_COMMIT
                  Rolled back at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
                  Rolled back by: ${{ github.actor }}
                  Reason: ${{ inputs.reason }}

                  Migration Status:
                  - Needs revert: ${{ needs.check-migration.outputs.needs_revert }}
                  - Revert count: ${{ needs.check-migration.outputs.revert_count }}

                  Rollback opportunity consumed."

                  git push -f origin ${{ env.PROD_TAG }}

                  echo "  âœ… ${{ env.PROD_TAG }} â†’ $ROLLBACK_COMMIT"

                  # åˆ é™¤ prod-prevï¼ˆæ¶ˆè€—å›æ»šæœºä¼šï¼‰
                  git push origin :${{ env.PROD_PREV_TAG }}

                  echo "  âœ… ${{ env.PROD_PREV_TAG }} å·²åˆ é™¤"
                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            - name: å›æ»šæ‘˜è¦
              run: |
                  echo ""
                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                  echo "âœ… ç”Ÿäº§ç¯å¢ƒå›æ»šå®Œæˆ"
                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                  echo ""
                  echo "ğŸ“Š å›æ»šæ‘˜è¦:"
                  echo "  å›æ»šåŸå› : ${{ inputs.reason }}"
                  echo "  å›æ»šåˆ°: $(git rev-parse ${{ env.PROD_TAG }})"
                  echo ""
                  echo "ğŸ—ƒï¸  æ•°æ®åº“:"
                  if [ "${{ needs.check-migration.outputs.needs_revert }}" = "true" ]; then
                      echo "  çŠ¶æ€: âœ… å·²å›é€€ ${{ needs.check-migration.outputs.revert_count }} ä¸ª migration"
                  else
                      echo "  çŠ¶æ€: â­ï¸  è·³è¿‡ï¼ˆæ— éœ€å›é€€ï¼‰"
                  fi
                  echo ""
                  echo "ğŸ·ï¸  Tags:"
                  echo "  ${{ env.PROD_TAG }} â†’ $(git rev-parse ${{ env.PROD_TAG }})"
                  echo "  ${{ env.PROD_PREV_TAG }}   â†’ (å·²åˆ é™¤)"
                  echo ""
                  echo "âš ï¸  é‡è¦æç¤º:"
                  echo "  â€¢ å›æ»šæœºä¼šå·²æ¶ˆè€—ï¼Œä¸‹æ¬¡éƒ¨ç½²å°†æ— æ³•å†æ¬¡å›æ»š"
                  echo "  â€¢ è¯·éªŒè¯ç”Ÿäº§ç¯å¢ƒåŠŸèƒ½æ˜¯å¦æ­£å¸¸"
                  echo "  â€¢ å°½å¿«ä¿®å¤å¯¼è‡´å›æ»šçš„é—®é¢˜"
                  echo "  â€¢ é€šè¿‡æ­£å¸¸ DEV â†’ PROD æµç¨‹é‡æ–°éƒ¨ç½²"
                  echo ""
                  echo "ğŸ”— æ§åˆ¶å°: ${{ env.TENCENT_CONSOLE_URL }}"
                  echo ""
                  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                  echo ""
                  echo "ğŸ“‹ åç»­æ£€æŸ¥æ¸…å•:"
                  echo "  1. [ ] éªŒè¯åº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œ"
                  echo "  2. [ ] æ£€æŸ¥å…³é”®åŠŸèƒ½æ˜¯å¦æ­£å¸¸"
                  echo "  3. [ ] æŸ¥çœ‹åº”ç”¨æ—¥å¿—æ˜¯å¦æœ‰å¼‚å¸¸"
                  echo "  4. [ ] æ£€æŸ¥æ•°æ®åº“æ•°æ®å®Œæ•´æ€§"
                  echo "  5. [ ] ä¿®å¤å¯¼è‡´å›æ»šçš„é—®é¢˜"
                  echo "  6. [ ] é‡æ–°é€šè¿‡ DEV â†’ PROD æµç¨‹éƒ¨ç½²"
                  echo ""
