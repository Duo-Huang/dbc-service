name: éƒ¨ç½²åˆ° DEV ç¯å¢ƒ

on:
    workflow_dispatch:
        inputs:
            ref:
                description: 'éƒ¨ç½²çš„åˆ†æ”¯/commit (é»˜è®¤: master)'
                required: false
                default: 'master'
                type: string
            reason:
                description: 'éƒ¨ç½²åŸå›  (å¯é€‰)'
                required: false
                type: string

# å…¨å±€ç¯å¢ƒå˜é‡
env:
    NODE_VERSION: 20.19.5
    HUSKY: 0 # CI ç¯å¢ƒä¸­ç¦ç”¨ husky
    TENCENT_CONSOLE_URL: https://console.cloud.tencent.com/sls # è…¾è®¯äº‘æ§åˆ¶å° URL
    DEV_TAG: dev-latest # DEV ç¯å¢ƒéƒ¨ç½²æ ‡ç­¾

# æƒé™é…ç½®ï¼ˆå…è®¸åˆ›å»ºå’Œæ¨é€ tagï¼‰
permissions:
    contents: write

# é˜²æ­¢å¹¶å‘éƒ¨ç½²
concurrency:
    group: deploy-dev
    cancel-in-progress: false

jobs:
    # ====================================
    # å˜æ›´æ£€æµ‹ï¼ˆæ‰€æœ‰åç»­ job ä¾èµ–æ­¤ç»“æœï¼‰
    # ====================================
    detect-changes:
        name: æ£€æµ‹å˜æ›´
        runs-on: ubuntu-latest
        outputs:
            # å˜æ›´æ£€æµ‹è„šæœ¬è¾“å‡ºï¼ˆå·²åŒ…å«å½±å“å…³ç³»ï¼‰
            layer_changed: ${{ steps.detect.outputs.layer_changed }}
            shared_changed: ${{ steps.detect.outputs.shared_changed }}
            console_changed: ${{ steps.detect.outputs.console_changed }}
            miniapp_changed: ${{ steps.detect.outputs.miniapp_changed }}
            deploy_ref: ${{ steps.set-ref.outputs.deploy_ref }}
        steps:
            - name: è®¾ç½®éƒ¨ç½²å¼•ç”¨
              id: set-ref
              run: |
                  REF="${{ inputs.ref }}"
                  if [ -z "$REF" ]; then
                      REF="master"
                  fi
                  echo "deploy_ref=$REF" >> $GITHUB_OUTPUT
                  echo "ğŸ“Œ å°†ä» $REF éƒ¨ç½²"

            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4
              with:
                  ref: ${{ steps.set-ref.outputs.deploy_ref }}
                  fetch-depth: 0 # éœ€è¦å®Œæ•´ git å†å²ï¼ˆåŒ…æ‹¬ tagsï¼‰

            - name: ç¡®ä¿ jq å·²å®‰è£…
              run: |
                  if ! command -v jq &> /dev/null; then
                      echo "å®‰è£… jq..."
                      sudo apt-get update && sudo apt-get install -y jq
                  else
                      echo "jq å·²å®‰è£…: $(jq --version)"
                  fi

            - name: æ£€æµ‹å˜æ›´
              id: detect
              run: |
                  chmod +x ./deployment/detect-changes.sh
                  ./deployment/detect-changes.sh
              env:
                  BASE_TAG: ${{ env.DEV_TAG }}
                  TARGET_REF: ${{ steps.set-ref.outputs.deploy_ref }}

            - name: è¾“å‡ºæ£€æµ‹ç»“æœ
              run: |
                  echo "ğŸ“Š å˜æ›´æ£€æµ‹ç»“æœ:"
                  echo "  Layer Changed:    ${{ steps.detect.outputs.layer_changed }}"
                  echo "  Shared Changed:   ${{ steps.detect.outputs.shared_changed }}"
                  echo "  Console Changed:  ${{ steps.detect.outputs.console_changed }}"
                  echo "  Miniapp Changed:  ${{ steps.detect.outputs.miniapp_changed }}"
                  echo ""
                  echo "ğŸ’¡ è¯´æ˜:"
                  echo "  - Console/Miniapp Changed å·²åŒ…å« Shared çš„å½±å“"
                  echo "  - è°ƒç”¨è€…å¯ç›´æ¥ä½¿ç”¨è¿™äº›çŠ¶æ€åšæµ‹è¯•/éƒ¨ç½²å†³ç­–"

    # ====================================
    # æ„å»ºï¼ˆä¸ Lintã€å•å…ƒæµ‹è¯•å¹¶è¡Œï¼‰
    # ====================================
    build:
        name: æ„å»ºé¡¹ç›®
        runs-on: ubuntu-latest
        needs: [detect-changes]
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4
              with:
                  ref: ${{ needs.detect-changes.outputs.deploy_ref }}

            - name: å®‰è£… pnpm
              uses: pnpm/action-setup@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: æ„å»ºé¡¹ç›®
              run: pnpm build

            - name: ä¸Šä¼ æ„å»ºäº§ç‰©
              uses: actions/upload-artifact@v4
              with:
                  name: dist-files
                  path: dist/
                  retention-days: 1

    # ====================================
    # Lintï¼ˆä¸æ„å»ºã€å•å…ƒæµ‹è¯•å¹¶è¡Œï¼‰
    # ====================================
    lint:
        name: ä»£ç æ£€æŸ¥
        runs-on: ubuntu-latest
        needs: [detect-changes]
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4
              with:
                  ref: ${{ needs.detect-changes.outputs.deploy_ref }}

            - name: å®‰è£… pnpm
              uses: pnpm/action-setup@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: ä»£ç æ£€æŸ¥
              run: pnpm lint

    # ====================================
    # å•å…ƒæµ‹è¯•ï¼ˆä¸æ„å»ºã€Lint å¹¶è¡Œï¼‰
    # ====================================
    unit-test:
        name: å•å…ƒæµ‹è¯•
        runs-on: ubuntu-latest
        needs: [detect-changes]
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4
              with:
                  ref: ${{ needs.detect-changes.outputs.deploy_ref }}

            - name: å®‰è£… pnpm
              uses: pnpm/action-setup@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: è¿è¡Œå•å…ƒæµ‹è¯•
              run: pnpm test

    # ====================================
    # Console E2E æµ‹è¯•ï¼ˆæŒ‰éœ€æ‰§è¡Œï¼‰
    # ====================================
    e2e-console:
        name: Console E2E æµ‹è¯•
        runs-on: ubuntu-latest
        needs: [detect-changes, build, lint, unit-test]
        if: needs.detect-changes.outputs.console_changed == 'true'
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4
              with:
                  ref: ${{ needs.detect-changes.outputs.deploy_ref }}

            - name: å®‰è£… pnpm
              uses: pnpm/action-setup@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: è¿è¡Œ Console E2E æµ‹è¯•
              run: pnpm test:e2e:console

    # ====================================
    # Miniapp E2E æµ‹è¯•ï¼ˆæŒ‰éœ€æ‰§è¡Œï¼‰
    # ====================================
    e2e-miniapp:
        name: Miniapp E2E æµ‹è¯•
        runs-on: ubuntu-latest
        needs: [detect-changes, build, lint, unit-test]
        if: needs.detect-changes.outputs.miniapp_changed == 'true'
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4
              with:
                  ref: ${{ needs.detect-changes.outputs.deploy_ref }}

            - name: å®‰è£… pnpm
              uses: pnpm/action-setup@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: è¿è¡Œ Miniapp E2E æµ‹è¯•
              run: pnpm test:e2e:miniapp

    # ====================================
    # æ•°æ®åº“è¿ç§»
    # ====================================
    migration-dev:
        name: æ•°æ®åº“è¿ç§»
        runs-on: ubuntu-latest
        needs:
            [detect-changes, build, lint, unit-test, e2e-console, e2e-miniapp]
        if: |
            !contains(needs.*.result, 'failure') &&
            !contains(needs.*.result, 'cancelled')
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4
              with:
                  ref: ${{ needs.detect-changes.outputs.deploy_ref }}

            - name: å®‰è£… pnpm
              uses: pnpm/action-setup@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: è¿è¡Œ migration
              run: pnpm migration run --prod
              env:
                  MIGRATION_DB_HOST: ${{ secrets.DEV_MIGRATION_DB_HOST }}
                  MIGRATION_DB_PORT: ${{ secrets.DEV_MIGRATION_DB_PORT }}
                  MIGRATION_DB_NAME: ${{ secrets.DEV_MIGRATION_DB_NAME }}
                  MIGRATION_DB_SCHEMA: ${{ secrets.DEV_MIGRATION_DB_SCHEMA }}
                  MIGRATION_USER: ${{ secrets.DEV_MIGRATION_USER }}
                  MIGRATION_PASSWORD: ${{ secrets.DEV_MIGRATION_PASSWORD }}

    # ====================================
    # éƒ¨ç½²ï¼ˆå¤ç”¨æ„å»ºäº§ç‰©ï¼‰
    # ====================================
    deploy-dev:
        name: éƒ¨ç½² DEV
        runs-on: ubuntu-latest
        needs:
            [
                detect-changes,
                build,
                lint,
                unit-test,
                e2e-console,
                e2e-miniapp,
                migration-dev,
            ]
        if: |
            (needs.detect-changes.outputs.console_changed == 'true' ||
             needs.detect-changes.outputs.miniapp_changed == 'true' ||
             needs.detect-changes.outputs.layer_changed == 'true') &&
            !contains(needs.*.result, 'failure') &&
            !contains(needs.*.result, 'cancelled')
        environment:
            name: dev
            url: ${{ env.TENCENT_CONSOLE_URL }}
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4
              with:
                  ref: ${{ needs.detect-changes.outputs.deploy_ref }}

            - name: å®‰è£… pnpm
              uses: pnpm/action-setup@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: ä¸‹è½½æ„å»ºäº§ç‰©
              uses: actions/download-artifact@v4
              with:
                  name: dist-files
                  path: dist/
            - name: ç¡®ä¿ jq å·²å®‰è£…
              run: |
                  if ! command -v jq &> /dev/null; then
                      echo "å®‰è£… jq..."
                      sudo apt-get update && sudo apt-get install -y jq
                  else
                      echo "jq å·²å®‰è£…: $(jq --version)"
                  fi
            - name: å®‰è£… SCF CLI
              run: |
                  # pnpm/action-setup@v4 å·²è‡ªåŠ¨é…ç½® PNPM_HOMEï¼Œæ— éœ€ pnpm setup
                  pnpm add -g serverless-cloud-framework@1.3.2
                  scf --version
            - name: éƒ¨ç½²åˆ° DEV
              run: |
                  echo "å¼€å§‹å˜æ›´æ£€æµ‹å’Œéƒ¨ç½²..."
                  chmod +x ./deployment/ci-deploy.sh
                  ./deployment/ci-deploy.sh
              env:
                  STAGE: dev
                  SERVERLESS_PLATFORM_VENDOR: tencent # serverless å¢ƒå¤–é»˜è®¤ä¸º awsï¼Œé…ç½®ä¸ºè…¾è®¯
                  # ä¼ é€’å˜æ›´æ£€æµ‹ç»“æœï¼Œé¿å…é‡å¤æ£€æµ‹
                  LAYER_CHANGED: ${{ needs.detect-changes.outputs.layer_changed }}
                  CONSOLE_CHANGED: ${{ needs.detect-changes.outputs.console_changed }}
                  MINIAPP_CHANGED: ${{ needs.detect-changes.outputs.miniapp_changed }}
                  # è…¾è®¯äº‘å‡­è¯
                  TENCENT_SECRET_ID: ${{ secrets.DEV_TENCENT_SECRET_ID }}
                  TENCENT_SECRET_KEY: ${{ secrets.DEV_TENCENT_SECRET_KEY }}
                  # åŒºåŸŸé…ç½®
                  REGION: ap-chengdu
                  # Console åº”ç”¨æ•°æ®åº“é…ç½®
                  CONSOLE_DB_HOST: ${{ secrets.DEV_CONSOLE_DB_HOST }}
                  CONSOLE_DB_PORT: ${{ secrets.DEV_CONSOLE_DB_PORT }}
                  CONSOLE_DB_NAME: ${{ secrets.DEV_CONSOLE_DB_NAME }}
                  CONSOLE_DB_SCHEMA: ${{ secrets.DEV_CONSOLE_DB_SCHEMA }}
                  CONSOLE_DB_USER: ${{ secrets.DEV_CONSOLE_DB_USER }}
                  CONSOLE_DB_PASSWORD: ${{ secrets.DEV_CONSOLE_DB_PASSWORD }}
                  # Miniapp åº”ç”¨æ•°æ®åº“é…ç½®
                  MINIAPP_DB_HOST: ${{ secrets.DEV_MINIAPP_DB_HOST }}
                  MINIAPP_DB_PORT: ${{ secrets.DEV_MINIAPP_DB_PORT }}
                  MINIAPP_DB_NAME: ${{ secrets.DEV_MINIAPP_DB_NAME }}
                  MINIAPP_DB_SCHEMA: ${{ secrets.DEV_MINIAPP_DB_SCHEMA }}
                  MINIAPP_DB_USER: ${{ secrets.DEV_MINIAPP_DB_USER }}
                  MINIAPP_DB_PASSWORD: ${{ secrets.DEV_MINIAPP_DB_PASSWORD }}

            - name: æ›´æ–° DEV éƒ¨ç½²æ ‡ç­¾
              run: |
                  DEPLOY_COMMIT=$(git rev-parse HEAD)

                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  # åˆ›å»º/æ›´æ–° DEV tagï¼ˆå¼ºåˆ¶è¦†ç›–ï¼‰
                  git tag -f ${{ env.DEV_TAG }} -m "ğŸš€ Deployed to DEV environment

                  Ref: ${{ needs.detect-changes.outputs.deploy_ref }}
                  Commit: $DEPLOY_COMMIT
                  Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
                  Deployed by: ${{ github.actor }}
                  Reason: ${{ inputs.reason || 'N/A' }}

                  Changes:
                  - Console: ${{ needs.detect-changes.outputs.console_changed }}
                  - Miniapp: ${{ needs.detect-changes.outputs.miniapp_changed }}
                  - Layer: ${{ needs.detect-changes.outputs.layer_changed }}"

                  git push -f origin ${{ env.DEV_TAG }}

                  echo "âœ… DEV éƒ¨ç½²æ ‡ç­¾å·²æ›´æ–°: ${{ env.DEV_TAG }} â†’ $DEPLOY_COMMIT"
