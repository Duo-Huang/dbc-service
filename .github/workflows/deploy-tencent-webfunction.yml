name: éƒ¨ç½²åˆ°è…¾è®¯äº‘ Web Function

# åŸºäºè…¾è®¯äº‘å®˜æ–¹æ–‡æ¡£ï¼šhttps://cloud.tencent.com/document/product/1154/59341
# ä½¿ç”¨ SCF Web Function ç›´æ¥è¿è¡Œ Nest.js åº”ç”¨

on:
    push:
        branches:
            - master
            - main
    pull_request:
        branches:
            - master
            - main
    workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘å®Œæ•´æµç¨‹ï¼ˆæµ‹è¯• + DEV + ç­‰å¾… Approval + PRODï¼‰

# å…¨å±€ç¯å¢ƒå˜é‡
env:
    HUSKY: 0 # CI ç¯å¢ƒä¸­ç¦ç”¨ husky
    TENCENT_CONSOLE_URL: https://console.cloud.tencent.com/sls # è…¾è®¯äº‘æ§åˆ¶å° URL

# æƒé™é…ç½®ï¼ˆå…è®¸åˆ›å»ºå’Œæ¨é€ tagï¼‰
permissions:
    contents: write

# é˜²æ­¢å¹¶å‘éƒ¨ç½²
concurrency:
    group: deploy-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # ====================================
    # å˜æ›´æ£€æµ‹ï¼ˆæ‰€æœ‰åç»­ job ä¾èµ–æ­¤ç»“æœï¼‰
    # ====================================
    detect-changes:
        name: æ£€æµ‹å˜æ›´
        runs-on: ubuntu-latest
        outputs:
            # å˜æ›´æ£€æµ‹è„šæœ¬è¾“å‡ºï¼ˆå·²åŒ…å«å½±å“å…³ç³»ï¼‰
            layer_changed: ${{ steps.detect.outputs.layer_changed }}
            shared_changed: ${{ steps.detect.outputs.shared_changed }}
            console_changed: ${{ steps.detect.outputs.console_changed }}
            miniapp_changed: ${{ steps.detect.outputs.miniapp_changed }}
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2 # éœ€è¦å‰ä¸€ä¸ª commit ç”¨äºå¯¹æ¯”

            - name: ç¡®ä¿ jq å·²å®‰è£…
              run: |
                  if ! command -v jq &> /dev/null; then
                      echo "å®‰è£… jq..."
                      sudo apt-get update && sudo apt-get install -y jq
                  else
                      echo "jq å·²å®‰è£…: $(jq --version)"
                  fi

            - name: æ£€æµ‹å˜æ›´
              id: detect
              run: |
                  chmod +x ./deployment/detect-changes.sh
                  ./deployment/detect-changes.sh

            - name: è¾“å‡ºæ£€æµ‹ç»“æœ
              run: |
                  echo "ğŸ“Š å˜æ›´æ£€æµ‹ç»“æœ:"
                  echo "  Layer Changed:    ${{ steps.detect.outputs.layer_changed }}"
                  echo "  Shared Changed:   ${{ steps.detect.outputs.shared_changed }}"
                  echo "  Console Changed:  ${{ steps.detect.outputs.console_changed }}"
                  echo "  Miniapp Changed:  ${{ steps.detect.outputs.miniapp_changed }}"
                  echo ""
                  echo "ğŸ’¡ è¯´æ˜:"
                  echo "  - Console/Miniapp Changed å·²åŒ…å« Shared çš„å½±å“"
                  echo "  - è°ƒç”¨è€…å¯ç›´æ¥ä½¿ç”¨è¿™äº›çŠ¶æ€åšæµ‹è¯•/éƒ¨ç½²å†³ç­–"

    # ====================================
    # æ„å»ºï¼ˆä¸ Lintã€å•å…ƒæµ‹è¯•å¹¶è¡Œï¼‰
    # ====================================
    build:
        name: æ„å»ºé¡¹ç›®
        runs-on: ubuntu-latest
        needs: [detect-changes]
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: å®‰è£… pnpm
              uses: pnpm/action-setup@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22'
                  cache: 'pnpm'

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: æ„å»ºé¡¹ç›®
              run: pnpm build

            - name: ä¸Šä¼ æ„å»ºäº§ç‰©
              uses: actions/upload-artifact@v4
              with:
                  name: dist-files
                  path: dist/
                  retention-days: 1

    # ====================================
    # Lintï¼ˆä¸æ„å»ºã€å•å…ƒæµ‹è¯•å¹¶è¡Œï¼‰
    # ====================================
    lint:
        name: ä»£ç æ£€æŸ¥
        runs-on: ubuntu-latest
        needs: [detect-changes]
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: å®‰è£… pnpm
              uses: pnpm/action-setup@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22'
                  cache: 'pnpm'

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: ä»£ç æ£€æŸ¥
              run: pnpm lint

    # ====================================
    # å•å…ƒæµ‹è¯•ï¼ˆä¸æ„å»ºã€Lint å¹¶è¡Œï¼‰
    # ====================================
    unit-test:
        name: å•å…ƒæµ‹è¯•
        runs-on: ubuntu-latest
        needs: [detect-changes]
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: å®‰è£… pnpm
              uses: pnpm/action-setup@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22'
                  cache: 'pnpm'

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: è¿è¡Œå•å…ƒæµ‹è¯•
              run: pnpm test

    # ====================================
    # Console E2E æµ‹è¯•ï¼ˆæŒ‰éœ€æ‰§è¡Œï¼‰
    # ====================================
    e2e-console:
        name: Console E2E æµ‹è¯•
        runs-on: ubuntu-latest
        needs: [detect-changes, build, lint, unit-test]
        if: needs.detect-changes.outputs.console_changed == 'true'
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: å®‰è£… pnpm
              uses: pnpm/action-setup@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22'
                  cache: 'pnpm'

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: è¿è¡Œ Console E2E æµ‹è¯•
              run: pnpm test:e2e:console

    # ====================================
    # Miniapp E2E æµ‹è¯•ï¼ˆæŒ‰éœ€æ‰§è¡Œï¼‰
    # ====================================
    e2e-miniapp:
        name: Miniapp E2E æµ‹è¯•
        runs-on: ubuntu-latest
        needs: [detect-changes, build, lint, unit-test]
        if: needs.detect-changes.outputs.miniapp_changed == 'true'
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: å®‰è£… pnpm
              uses: pnpm/action-setup@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22'
                  cache: 'pnpm'

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: è¿è¡Œ Miniapp E2E æµ‹è¯•
              run: pnpm test:e2e:miniapp

    # ====================================
    # éƒ¨ç½²ï¼ˆå¤ç”¨æ„å»ºäº§ç‰©ï¼‰
    # ====================================
    deploy-dev:
        name: éƒ¨ç½²DEVç¯å¢ƒ
        runs-on: ubuntu-latest
        needs:
            [detect-changes, build, lint, unit-test, e2e-console, e2e-miniapp]
        # push æˆ– workflow_dispatch è§¦å‘ DEV éƒ¨ç½²ï¼ŒPR åªæµ‹è¯•ä¸éƒ¨ç½²
        # å…è®¸æŸäº› e2e æµ‹è¯•è¢«è·³è¿‡ï¼ˆå¦‚æœæ²¡æœ‰å˜æ›´ï¼‰ï¼Œä½†å¦‚æœè¿è¡Œäº†å°±å¿…é¡»é€šè¿‡
        if: |
            (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
            (needs.detect-changes.outputs.console_changed == 'true' ||
             needs.detect-changes.outputs.miniapp_changed == 'true' ||
             needs.detect-changes.outputs.layer_changed == 'true') &&
            !contains(needs.*.result, 'failure') &&
            !contains(needs.*.result, 'cancelled')
        environment:
            name: dev
            url: ${{ env.TENCENT_CONSOLE_URL }}
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: å®‰è£… pnpm
              uses: pnpm/action-setup@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22'
                  cache: 'pnpm'

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: ä¸‹è½½æ„å»ºäº§ç‰©
              uses: actions/download-artifact@v4
              with:
                  name: dist-files
                  path: dist/

            - name: ç¡®ä¿ jq å·²å®‰è£…
              run: |
                  if ! command -v jq &> /dev/null; then
                      echo "å®‰è£… jq..."
                      sudo apt-get update && sudo apt-get install -y jq
                  else
                      echo "jq å·²å®‰è£…: $(jq --version)"
                  fi

            - name: å®‰è£… SCF CLI
              run: |
                  # pnpm/action-setup@v4 å·²è‡ªåŠ¨é…ç½® PNPM_HOMEï¼Œæ— éœ€ pnpm setup
                  pnpm add -g serverless-cloud-framework@1.3.2
                  scf --version

            - name: æ£€æµ‹å˜æ›´å¹¶éƒ¨ç½²
              run: |
                  echo "å¼€å§‹å˜æ›´æ£€æµ‹å’Œéƒ¨ç½²..."
                  chmod +x ./deployment/ci-deploy.sh
                  ./deployment/ci-deploy.sh
              env:
                  STAGE: dev
                  SERVERLESS_PLATFORM_VENDOR: tencent #serverless å¢ƒå¤–é»˜è®¤ä¸º awsï¼Œé…ç½®ä¸ºè…¾è®¯
                  # ä¼ é€’å˜æ›´æ£€æµ‹ç»“æœï¼Œé¿å…é‡å¤æ£€æµ‹
                  LAYER_CHANGED: ${{ needs.detect-changes.outputs.layer_changed }}
                  CONSOLE_CHANGED: ${{ needs.detect-changes.outputs.console_changed }}
                  MINIAPP_CHANGED: ${{ needs.detect-changes.outputs.miniapp_changed }}
                  # è…¾è®¯äº‘å‡­è¯
                  TENCENT_SECRET_ID: ${{ secrets.TENCENT_SECRET_ID_DEV }}
                  TENCENT_SECRET_KEY: ${{ secrets.TENCENT_SECRET_KEY_DEV }}

            - name: æ›´æ–° DEV éƒ¨ç½²æ ‡ç­¾
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  # åˆ›å»º/æ›´æ–° latest-dev tagï¼ˆå¼ºåˆ¶è¦†ç›–ï¼‰
                  git tag -f latest-dev -m "ğŸš€ Deployed to DEV environment

                  Commit: ${{ github.sha }}
                  Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
                  Deployed by: ${{ github.actor }}
                  Workflow: ${{ github.run_id }}

                  Changes:
                  - Console: ${{ needs.detect-changes.outputs.console_changed }}
                  - Miniapp: ${{ needs.detect-changes.outputs.miniapp_changed }}
                  - Layer: ${{ needs.detect-changes.outputs.layer_changed }}"

                  git push -f origin latest-dev

                  echo "âœ… DEV éƒ¨ç½²æ ‡ç­¾å·²æ›´æ–°: latest-dev â†’ ${{ github.sha }}"

            - name: è¾“å‡ºéƒ¨ç½²ç»“æœ
              run: |
                  echo "ğŸ‰ DEV ç¯å¢ƒéƒ¨ç½²å®Œæˆï¼"
                  echo "ğŸ“Œ Commit: ${{ github.sha }}"
                  echo "ğŸ·ï¸  Tag: latest-dev"
                  echo "æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€: ${{ env.TENCENT_CONSOLE_URL }}"
                  echo ""
                  echo "ğŸ’¡ æŸ¥çœ‹ tag: git fetch --tags && git log --oneline --decorate -10"

    # ====================================
    # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼ˆéœ€è¦æ‰‹åŠ¨ Approvalï¼‰
    # ====================================
    deploy-prod:
        name: éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ
        runs-on: ubuntu-latest
        needs: [detect-changes, deploy-dev] # ä¸‹é¢ä½¿ç”¨äº†detect-changesçš„è¾“å‡ºå˜é‡, è¿™é‡Œå¿…é¡»å®šä¹‰ä¾èµ–
        # DEV éƒ¨ç½²æˆåŠŸåï¼Œç­‰å¾…æ‰‹åŠ¨ Approvalï¼ˆé€šè¿‡ environment: production å®ç°ï¼‰
        if: needs.deploy-dev.result == 'success'
        environment:
            name: prod
            url: ${{ env.TENCENT_CONSOLE_URL }}
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: å®‰è£… pnpm
              uses: pnpm/action-setup@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22'
                  cache: 'pnpm'

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: ä¸‹è½½æ„å»ºäº§ç‰©
              uses: actions/download-artifact@v4
              with:
                  name: dist-files
                  path: dist/

            - name: ç¡®ä¿ jq å·²å®‰è£…
              run: |
                  if ! command -v jq &> /dev/null; then
                      echo "å®‰è£… jq..."
                      sudo apt-get update && sudo apt-get install -y jq
                  else
                      echo "jq å·²å®‰è£…: $(jq --version)"
                  fi

            - name: å®‰è£… SCF CLI
              run: |
                  # pnpm/action-setup@v4 å·²è‡ªåŠ¨é…ç½® PNPM_HOMEï¼Œæ— éœ€ pnpm setup
                  pnpm add -g serverless-cloud-framework@1.3.2
                  scf --version

            - name: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ç¡®è®¤
              run: |
                  echo "âš ï¸  å‡†å¤‡éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ âš ï¸"
                  echo ""
                  echo "éƒ¨ç½²ä¿¡æ¯:"
                  echo "  ç¯å¢ƒ: PRODUCTION"
                  echo "  è§¦å‘æ–¹å¼: ${{ github.event_name }}"
                  echo "  åˆ†æ”¯/æ ‡ç­¾: ${{ github.ref }}"
                  echo "  æäº¤: ${{ github.sha }}"
                  echo ""
                  echo "å˜æ›´æƒ…å†µ:"
                  echo "  Layer: ${{ needs.detect-changes.outputs.layer_changed }}"
                  echo "  Console: ${{ needs.detect-changes.outputs.console_changed }}"
                  echo "  Miniapp: ${{ needs.detect-changes.outputs.miniapp_changed }}"
                  echo ""

            - name: æ£€æµ‹å˜æ›´å¹¶éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
              run: |
                  echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
                  chmod +x ./deployment/ci-deploy.sh
                  ./deployment/ci-deploy.sh
              env:
                  STAGE: prod
                  SERVERLESS_PLATFORM_VENDOR: tencent
                  # ä¼ é€’å˜æ›´æ£€æµ‹ç»“æœï¼Œé¿å…é‡å¤æ£€æµ‹
                  LAYER_CHANGED: ${{ needs.detect-changes.outputs.layer_changed }}
                  CONSOLE_CHANGED: ${{ needs.detect-changes.outputs.console_changed }}
                  MINIAPP_CHANGED: ${{ needs.detect-changes.outputs.miniapp_changed }}
                  # è…¾è®¯äº‘å‡­è¯ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
                  TENCENT_SECRET_ID: ${{ secrets.TENCENT_SECRET_ID_PROD }}
                  TENCENT_SECRET_KEY: ${{ secrets.TENCENT_SECRET_KEY_PROD }}

            - name: æ›´æ–°ç”Ÿäº§éƒ¨ç½²æ ‡ç­¾
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  # åˆ›å»º/æ›´æ–° latest-prod tagï¼ˆå¼ºåˆ¶è¦†ç›–ï¼‰
                  git tag -f latest-prod -m "ğŸš€ Deployed to PRODUCTION environment

                  Commit: ${{ github.sha }}
                  Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
                  Deployed by: ${{ github.actor }}
                  Workflow: ${{ github.run_id }}

                  Changes:
                  - Console: ${{ needs.detect-changes.outputs.console_changed }}
                  - Miniapp: ${{ needs.detect-changes.outputs.miniapp_changed }}
                  - Layer: ${{ needs.detect-changes.outputs.layer_changed }}"

                  git push -f origin latest-prod

                  echo "âœ… ç”Ÿäº§éƒ¨ç½²æ ‡ç­¾å·²æ›´æ–°: latest-prod â†’ ${{ github.sha }}"

            - name: è¾“å‡ºéƒ¨ç½²ç»“æœ
              run: |
                  echo "ğŸ‰ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆï¼"
                  echo "ğŸ“Œ Commit: ${{ github.sha }}"
                  echo "ğŸ·ï¸  Tag: latest-prod"
                  echo "æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€: ${{ env.TENCENT_CONSOLE_URL }}"
                  echo ""
                  echo "ğŸ’¡ æŸ¥çœ‹éƒ¨ç½²å†å²:"
                  echo "   - å½“å‰çŠ¶æ€: git fetch --tags && git log --oneline --decorate -10"
                  echo "   - ç¯å¢ƒå·®å¼‚: git log latest-prod..latest-dev --oneline"
                  echo "   - éƒ¨ç½²å†å²: git reflog show latest-prod -10"
                  echo ""
                  echo "âš ï¸  è¯·åŠæ—¶éªŒè¯ç”Ÿäº§ç¯å¢ƒåŠŸèƒ½æ˜¯å¦æ­£å¸¸"
