name: éƒ¨ç½²åˆ°è…¾è®¯äº‘ Web Function

# åŸºäºè…¾è®¯äº‘å®˜æ–¹æ–‡æ¡£ï¼šhttps://cloud.tencent.com/document/product/1154/59341
# ä½¿ç”¨ SCF Web Function ç›´æ¥è¿è¡Œ Nest.js åº”ç”¨

on:
    push:
        branches:
            - master
            - main
    pull_request:
        branches:
            - master
            - main

jobs:
    lint:
        name: ä»£ç æ£€æŸ¥
        runs-on: ubuntu-latest

        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: å®‰è£… pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'pnpm'

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: æ‰§è¡Œ Lint æ£€æŸ¥
              run: pnpm lint

    test:
        name: å•å…ƒæµ‹è¯•
        runs-on: ubuntu-latest

        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: å®‰è£… pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'pnpm'

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: æ‰§è¡Œæµ‹è¯•
              run: pnpm test

    build:
        name: æ„å»ºå’Œæ‰“åŒ…
        runs-on: ubuntu-latest
        needs: [lint, test]

        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: å®‰è£… pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'pnpm'

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: æ„å»ºé¡¹ç›®
              run: pnpm build

            - name: å®‰è£…ç”Ÿäº§ä¾èµ–
              run: |
                  echo "æ¸…ç† node_modules..."
                  rm -rf node_modules

                  echo "å®‰è£…ç”Ÿäº§ä¾èµ–..."
                  pnpm install --prod --frozen-lockfile

                  echo "node_modules å¤§å°:"
                  du -sh node_modules

            - name: å‡†å¤‡ Console éƒ¨ç½²åŒ…
              run: |
                  echo "å‡†å¤‡ Console åº”ç”¨éƒ¨ç½²åŒ…..."
                  mkdir -p deploy/console

                  # å¤åˆ¶æ„å»ºäº§ç‰©
                  cp -r dist/ deploy/console/

                  # å¤åˆ¶ç”Ÿäº§ä¾èµ–ï¼ˆWeb Function éœ€è¦ï¼‰
                  cp -r node_modules/ deploy/console/

                  # å¤åˆ¶ scf_bootstrap å¯åŠ¨æ–‡ä»¶
                  cp scf_bootstrap_console deploy/console/scf_bootstrap
                  chmod 777 deploy/console/scf_bootstrap

                  # å¤åˆ¶å¿…è¦æ–‡ä»¶
                  cp package.json deploy/console/

                  # æ˜¾ç¤ºæ–‡ä»¶ç»“æ„
                  echo "Console éƒ¨ç½²åŒ…ç»“æ„:"
                  ls -la deploy/console/

                  # æ‰“åŒ…ï¼ˆä¸è¶…è¿‡ 50MB å¯ç›´æ¥ä¸Šä¼ ï¼Œè¶…è¿‡éœ€è¦ç”¨ COSï¼‰
                  cd deploy/console
                  zip -r console.zip . -q
                  cd ../..

                  echo "Console å‹ç¼©åŒ…å¤§å°:"
                  du -sh deploy/console/console.zip

            - name: å‡†å¤‡ Miniapp éƒ¨ç½²åŒ…
              run: |
                  echo "å‡†å¤‡ Miniapp åº”ç”¨éƒ¨ç½²åŒ…..."
                  mkdir -p deploy/miniapp

                  # å¤åˆ¶æ„å»ºäº§ç‰©
                  cp -r dist/ deploy/miniapp/

                  # å¤åˆ¶ç”Ÿäº§ä¾èµ–
                  cp -r node_modules/ deploy/miniapp/

                  # å¤åˆ¶ scf_bootstrap å¯åŠ¨æ–‡ä»¶
                  cp scf_bootstrap_miniapp deploy/miniapp/scf_bootstrap
                  chmod 777 deploy/miniapp/scf_bootstrap

                  # å¤åˆ¶å¿…è¦æ–‡ä»¶
                  cp package.json deploy/miniapp/

                  # æ˜¾ç¤ºæ–‡ä»¶ç»“æ„
                  echo "Miniapp éƒ¨ç½²åŒ…ç»“æ„:"
                  ls -la deploy/miniapp/

                  # æ‰“åŒ…
                  cd deploy/miniapp
                  zip -r miniapp.zip . -q
                  cd ../..

                  echo "Miniapp å‹ç¼©åŒ…å¤§å°:"
                  du -sh deploy/miniapp/miniapp.zip

            - name: æ£€æŸ¥åŒ…å¤§å°
              run: |
                  echo "================================"
                  echo "æ£€æŸ¥éƒ¨ç½²åŒ…å¤§å°"
                  echo "================================"

                  CONSOLE_SIZE=$(du -m deploy/console/console.zip | cut -f1)
                  MINIAPP_SIZE=$(du -m deploy/miniapp/miniapp.zip | cut -f1)

                  echo "Console åŒ…: ${CONSOLE_SIZE}MB"
                  echo "Miniapp åŒ…: ${MINIAPP_SIZE}MB"
                  echo ""

                  # è…¾è®¯äº‘ Web Function é™åˆ¶
                  # - ç›´æ¥ä¸Šä¼ : 50MB
                  # - COS ä¸Šä¼ : 500MB

                  if [ $CONSOLE_SIZE -gt 50 ]; then
                      echo "âš ï¸  Console åŒ…è¶…è¿‡ 50MBï¼Œéœ€è¦é€šè¿‡ COS ä¸Šä¼ "
                  else
                      echo "âœ… Console åŒ…å¯ä»¥ç›´æ¥ä¸Šä¼ "
                  fi

                  if [ $MINIAPP_SIZE -gt 50 ]; then
                      echo "âš ï¸  Miniapp åŒ…è¶…è¿‡ 50MBï¼Œéœ€è¦é€šè¿‡ COS ä¸Šä¼ "
                  else
                      echo "âœ… Miniapp åŒ…å¯ä»¥ç›´æ¥ä¸Šä¼ "
                  fi

            - name: ä¸Šä¼ éƒ¨ç½²åŒ…
              uses: actions/upload-artifact@v4
              with:
                  name: webfunction-packages
                  path: |
                      deploy/console/console.zip
                      deploy/miniapp/miniapp.zip
                  retention-days: 7

    deploy:
        name: éƒ¨ç½²è¯´æ˜
        runs-on: ubuntu-latest
        needs: build
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'

        steps:
            - name: ä¸‹è½½éƒ¨ç½²åŒ…
              uses: actions/download-artifact@v4
              with:
                  name: webfunction-packages
                  path: deploy

            - name: æ˜¾ç¤ºéƒ¨ç½²åŒ…
              run: |
                  echo "éƒ¨ç½²åŒ…åˆ—è¡¨:"
                  ls -lh deploy/

            - name: éƒ¨ç½²è¯´æ˜
              run: |
                  echo "========================================"
                  echo "è…¾è®¯äº‘ Web Function éƒ¨ç½²åŒ…å·²å‡†å¤‡å®Œæˆ"
                  echo "========================================"
                  echo ""
                  echo "å‚è€ƒæ–‡æ¡£:"
                  echo "https://cloud.tencent.com/document/product/1154/59341"
                  echo ""
                  echo "ğŸ“¦ éƒ¨ç½²åŒ…åŒ…å«:"
                  echo "  âœ“ dist/ - æ„å»ºäº§ç‰©"
                  echo "  âœ“ node_modules/ - ç”Ÿäº§ä¾èµ–"
                  echo "  âœ“ scf_bootstrap - å¯åŠ¨è„šæœ¬ï¼ˆç›‘å¬ 0.0.0.0:9000ï¼‰"
                  echo "  âœ“ package.json"
                  echo ""
                  echo "ğŸš€ éƒ¨ç½²æ–¹å¼ï¼š"
                  echo ""
                  echo "æ–¹å¼ 1: é€šè¿‡æ§åˆ¶å°éƒ¨ç½²ï¼ˆæ¨èï¼‰"
                  echo "  1. è®¿é—® https://console.cloud.tencent.com/sls"
                  echo "  2. æ–°å»ºåº”ç”¨ â†’ Web åº”ç”¨ â†’ Nest.js æ¡†æ¶"
                  echo "  3. ä¸Šä¼ æ–¹å¼é€‰æ‹©ã€Œæœ¬åœ°ä¸Šä¼ ã€"
                  echo "  4. ä¸Šä¼  console.zip æˆ– miniapp.zip"
                  echo "  5. å®Œæˆéƒ¨ç½²"
                  echo ""
                  echo "æ–¹å¼ 2: é€šè¿‡ä»£ç ä»“åº“éƒ¨ç½²"
                  echo "  1. åœ¨æ§åˆ¶å°é€‰æ‹©ã€Œä»£ç ä»“åº“æ‹‰å–ã€"
                  echo "  2. æˆæƒ GitHub ä»“åº“è®¿é—®"
                  echo "  3. è‡ªåŠ¨éƒ¨ç½²"
                  echo ""
                  echo "æ–¹å¼ 3: ä½¿ç”¨ Serverless CLI"
                  echo "  serverless deploy --target ./deploy/console"
                  echo ""
                  echo "âš ï¸  æ³¨æ„äº‹é¡¹ï¼š"
                  echo "  â€¢ åº”ç”¨å·²é…ç½®ç›‘å¬ 0.0.0.0:9000ï¼ˆWeb Function è¦æ±‚ï¼‰"
                  echo "  â€¢ scf_bootstrap å·²è®¾ç½® 777 æƒé™"
                  echo "  â€¢ åŒ…å«å®Œæ•´ node_modulesï¼ˆWeb Function éœ€è¦ï¼‰"
                  echo "  â€¢ å¦‚æœè¶…è¿‡ 50MBï¼Œéœ€è¦é€šè¿‡ COS ä¸Šä¼ "
                  echo ""
                  echo "========================================"
