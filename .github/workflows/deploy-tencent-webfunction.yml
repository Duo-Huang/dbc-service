name: éƒ¨ç½²åˆ°è…¾è®¯äº‘ Web Function

# åŸºäºè…¾è®¯äº‘å®˜æ–¹æ–‡æ¡£ï¼šhttps://cloud.tencent.com/document/product/1154/59341
# ä½¿ç”¨ SCF Web Function ç›´æ¥è¿è¡Œ Nest.js åº”ç”¨

on:
    push:
        branches:
            - master
            - main
    pull_request:
        branches:
            - master
            - main

# é˜²æ­¢å¹¶å‘éƒ¨ç½²
concurrency:
    group: deploy-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # ====================================
    # å˜æ›´æ£€æµ‹ï¼ˆæ‰€æœ‰åç»­ job ä¾èµ–æ­¤ç»“æœï¼‰
    # ====================================
    detect-changes:
        name: æ£€æµ‹å˜æ›´
        runs-on: ubuntu-latest
        outputs:
            # å˜æ›´æ£€æµ‹è„šæœ¬è¾“å‡ºï¼ˆå·²åŒ…å«å½±å“å…³ç³»ï¼‰
            layer_changed: ${{ steps.detect.outputs.layer_changed }}
            shared_changed: ${{ steps.detect.outputs.shared_changed }}
            console_changed: ${{ steps.detect.outputs.console_changed }}
            miniapp_changed: ${{ steps.detect.outputs.miniapp_changed }}
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2 # éœ€è¦å‰ä¸€ä¸ª commit ç”¨äºå¯¹æ¯”

            - name: æ£€æµ‹å˜æ›´
              id: detect
              run: |
                  chmod +x ./deployment/detect-changes.sh
                  ./deployment/detect-changes.sh

            - name: è¾“å‡ºæ£€æµ‹ç»“æœ
              run: |
                  echo "ğŸ“Š å˜æ›´æ£€æµ‹ç»“æœ:"
                  echo "  Layer Changed:    ${{ steps.detect.outputs.layer_changed }}"
                  echo "  Shared Changed:   ${{ steps.detect.outputs.shared_changed }}"
                  echo "  Console Changed:  ${{ steps.detect.outputs.console_changed }}"
                  echo "  Miniapp Changed:  ${{ steps.detect.outputs.miniapp_changed }}"
                  echo ""
                  echo "ğŸ’¡ è¯´æ˜:"
                  echo "  - Console/Miniapp Changed å·²åŒ…å« Shared çš„å½±å“"
                  echo "  - è°ƒç”¨è€…å¯ç›´æ¥ä½¿ç”¨è¿™äº›çŠ¶æ€åšæµ‹è¯•/éƒ¨ç½²å†³ç­–"

    # ====================================
    # Lintï¼ˆæ€»æ˜¯æ‰§è¡Œï¼‰
    # ====================================
    lint:
        name: ä»£ç æ£€æŸ¥
        runs-on: ubuntu-latest
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'pnpm'

            - name: å®‰è£… pnpm
              run: npm install -g pnpm

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: ä»£ç æ£€æŸ¥
              run: pnpm lint

    # ====================================
    # å•å…ƒæµ‹è¯•ï¼ˆæ€»æ˜¯æ‰§è¡Œ - å¿«é€Ÿä¸”å…¨é¢ï¼‰
    # ====================================
    unit-test:
        name: å•å…ƒæµ‹è¯•
        runs-on: ubuntu-latest
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'pnpm'

            - name: å®‰è£… pnpm
              run: npm install -g pnpm

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: è¿è¡Œå•å…ƒæµ‹è¯•
              run: pnpm test

    # ====================================
    # Console E2E æµ‹è¯•ï¼ˆæŒ‰éœ€æ‰§è¡Œï¼‰
    # ====================================
    e2e-console:
        name: Console E2E æµ‹è¯•
        runs-on: ubuntu-latest
        needs: [detect-changes, unit-test]
        if: needs.detect-changes.outputs.console_changed == 'true'
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'pnpm'

            - name: å®‰è£… pnpm
              run: npm install -g pnpm

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: è¿è¡Œ Console E2E æµ‹è¯•
              run: pnpm test:e2e:console

    # ====================================
    # Miniapp E2E æµ‹è¯•ï¼ˆæŒ‰éœ€æ‰§è¡Œï¼‰
    # ====================================
    e2e-miniapp:
        name: Miniapp E2E æµ‹è¯•
        runs-on: ubuntu-latest
        needs: [detect-changes, unit-test]
        if: needs.detect-changes.outputs.miniapp_changed == 'true'
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'pnpm'

            - name: å®‰è£… pnpm
              run: npm install -g pnpm

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: è¿è¡Œ Miniapp E2E æµ‹è¯•
              run: pnpm test:e2e:miniapp

    # ====================================
    # æ„å»ºå’Œéƒ¨ç½²
    # ====================================
    build-and-deploy:
        name: æ„å»ºå’Œéƒ¨ç½²
        runs-on: ubuntu-latest
        needs: [detect-changes, lint, unit-test, e2e-console, e2e-miniapp]
        # åªæœ‰åœ¨ push äº‹ä»¶æ—¶æ‰éƒ¨ç½²ï¼ŒPR åªæµ‹è¯•ä¸éƒ¨ç½²
        if: |
            github.event_name == 'push' &&
            (needs.detect-changes.outputs.console_changed == 'true' ||
             needs.detect-changes.outputs.miniapp_changed == 'true' ||
             needs.detect-changes.outputs.layer_changed == 'true')
        # å…è®¸æŸäº› e2e æµ‹è¯•è¢«è·³è¿‡ï¼ˆå¦‚æœæ²¡æœ‰å˜æ›´ï¼‰
        # ä½†å¦‚æœè¿è¡Œäº†å°±å¿…é¡»é€šè¿‡
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'pnpm'

            - name: å®‰è£… pnpm
              run: npm install -g pnpm

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: æ„å»ºé¡¹ç›®
              run: pnpm build

            - name: å®‰è£… SCF CLI
              run: npm install -g @serverless/cli

            - name: é…ç½®è…¾è®¯äº‘å‡­è¯
              run: |
                  echo "é…ç½®è…¾è®¯äº‘å‡­è¯..."
                  export TENCENT_SECRET_ID=${{ secrets.TENCENT_SECRET_ID }}
                  export TENCENT_SECRET_KEY=${{ secrets.TENCENT_SECRET_KEY }}

            - name: æ£€æµ‹å˜æ›´å¹¶éƒ¨ç½²
              run: |
                  echo "å¼€å§‹å˜æ›´æ£€æµ‹å’Œéƒ¨ç½²..."
                  chmod +x ./deployment/ci-deploy.sh
                  ./deployment/ci-deploy.sh

            - name: è¾“å‡ºéƒ¨ç½²ç»“æœ
              run: |
                  echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
                  echo "æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€: https://console.cloud.tencent.com/scf"
