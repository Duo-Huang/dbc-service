name: å®šæœŸå…¨é‡æµ‹è¯•

# å®šæœŸè¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼Œç¡®ä¿ä»£ç è´¨é‡
# å³ä½¿æ²¡æœ‰ä»£ç å˜æ›´ï¼Œä¹Ÿèƒ½å‘ç°æ½œåœ¨é—®é¢˜ï¼ˆå¦‚ä¾èµ–æ›´æ–°å¯¼è‡´çš„é—®é¢˜ï¼‰

on:
    schedule:
        # æ¯å¤©å‡Œæ™¨ 2 ç‚¹è¿è¡Œï¼ˆUTC æ—¶é—´ï¼‰
        - cron: '0 2 * * *'
    workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
    full-test:
        name: å…¨é‡æµ‹è¯•
        runs-on: ubuntu-latest
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'pnpm'

            - name: å®‰è£… pnpm
              run: npm install -g pnpm

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: ä»£ç æ£€æŸ¥
              run: pnpm lint

            - name: è¿è¡Œå•å…ƒæµ‹è¯•
              run: pnpm test

            - name: è¿è¡Œ E2E æµ‹è¯•ï¼ˆå¸¦è¦†ç›–ç‡ï¼‰
              run: pnpm test:e2e

            - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
              if: always()
              run: |
                  echo "ğŸ“Š æµ‹è¯•å®Œæˆ"
                  echo "æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ä»¥äº†è§£æµ‹è¯•ç»“æœ"

            - name: å‘é€å¤±è´¥é€šçŸ¥
              if: failure()
              uses: actions/github-script@v7
              with:
                  script: |
                      const issueTitle = 'ğŸš¨ å®šæœŸæµ‹è¯•å¤±è´¥ - ' + new Date().toISOString().split('T')[0];
                      const issueBody = `
                      ## å®šæœŸæµ‹è¯•å¤±è´¥

                      **æ—¶é—´**: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}
                      **Workflow**: [æŸ¥çœ‹è¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

                      ### å¯èƒ½çš„åŸå› 
                      - ä¾èµ–åŒ…æ›´æ–°å¯¼è‡´çš„å…¼å®¹æ€§é—®é¢˜
                      - å¤–éƒ¨æœåŠ¡ä¸å¯ç”¨
                      - ç¯å¢ƒé…ç½®é—®é¢˜

                      ### å»ºè®®æ“ä½œ
                      1. æŸ¥çœ‹ workflow æ—¥å¿—å®šä½å…·ä½“å¤±è´¥çš„æµ‹è¯•
                      2. æ£€æŸ¥æœ€è¿‘çš„ä¾èµ–æ›´æ–°
                      3. éªŒè¯æµ‹è¯•ç¯å¢ƒé…ç½®

                      ---
                      *æ­¤ issue ç”±å®šæœŸæµ‹è¯•è‡ªåŠ¨åˆ›å»º*
                      `;

                      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ ‡é¢˜çš„ issue
                      const issues = await github.rest.issues.listForRepo({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        state: 'open',
                        labels: ['automated-test', 'scheduled-test']
                      });

                      const existingIssue = issues.data.find(issue => issue.title === issueTitle);

                      if (!existingIssue) {
                        await github.rest.issues.create({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          title: issueTitle,
                          body: issueBody,
                          labels: ['automated-test', 'scheduled-test', 'bug']
                        });
                      } else {
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: existingIssue.number,
                          body: 'å®šæœŸæµ‹è¯•å†æ¬¡å¤±è´¥ï¼Œè¯·å°½å¿«å¤„ç†ï¼\n\n[æŸ¥çœ‹è¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})'
                        });
                      }
