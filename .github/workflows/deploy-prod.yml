name: 部署到生产环境

on:
    workflow_dispatch:
        inputs:
            confirm:
                description: '确认部署到生产（输入 DEPLOY）'
                required: true
                type: string

# 全局环境变量
env:
    NODE_VERSION: 20.19.5
    HUSKY: 0 # CI 环境中禁用 husky
    TENCENT_CONSOLE_URL: https://console.cloud.tencent.com/sls # 腾讯云控制台 URL
    DEV_TAG: dev-latest # DEV 环境部署标签
    PROD_TAG: prod-latest # PROD 环境部署标签
    PROD_PREV_TAG: prod-prev # PROD 上一版本标签（用于回滚）

# 权限配置（允许创建和推送 tag）
permissions:
    contents: write

# 防止并发部署
concurrency:
    group: deploy-prod
    cancel-in-progress: false

jobs:
    validate:
        name: 验证部署条件
        runs-on: ubuntu-latest
        steps:
            - name: 验证确认输入
              run: |
                  if [ "${{ inputs.confirm }}" != "DEPLOY" ]; then
                      echo "❌ 确认输入错误，必须输入 'DEPLOY'"
                      exit 1
                  fi

            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: 验证 DEV 部署标签存在
              run: |
                  if ! git rev-parse ${{ env.DEV_TAG }} >/dev/null 2>&1; then
                      echo "❌ ${{ env.DEV_TAG }} tag 不存在，请先部署 DEV"
                      exit 1
                  fi

                  DEV_COMMIT=$(git rev-parse ${{ env.DEV_TAG }})
                  echo "✅ 将从 ${{ env.DEV_TAG }} 部署"
                  echo "   Commit: $DEV_COMMIT"

    detect-changes:
        name: 检测变更
        runs-on: ubuntu-latest
        needs: [validate]
        outputs:
            layer_changed: ${{ steps.detect.outputs.layer_changed }}
            shared_changed: ${{ steps.detect.outputs.shared_changed }}
            console_changed: ${{ steps.detect.outputs.console_changed }}
            miniprogram_changed: ${{ steps.detect.outputs.miniprogram_changed }}
        steps:
            - uses: actions/checkout@v4
              with:
                  ref: ${{ env.DEV_TAG }}
                  fetch-depth: 0 # 需要完整 git 历史（包括 tags）

            - name: 确保 jq 已安装
              run: |
                  if ! command -v jq &> /dev/null; then
                      echo "安装 jq..."
                      sudo apt-get update && sudo apt-get install -y jq
                  else
                      echo "jq 已安装: $(jq --version)"
                  fi

            - name: 检测变更
              id: detect
              run: |
                  chmod +x ./deployment/detect-changes.sh
                  ./deployment/detect-changes.sh
              env:
                  BASE_TAG: ${{ env.PROD_TAG }}
                  TARGET_REF: ${{ env.DEV_TAG }}

            - name: 输出检测结果
              run: |
                  echo "📊 变更检测结果:"
                  echo "  Layer Changed:    ${{ steps.detect.outputs.layer_changed }}"
                  echo "  Shared Changed:   ${{ steps.detect.outputs.shared_changed }}"
                  echo "  Console Changed:  ${{ steps.detect.outputs.console_changed }}"
                  echo "  Miniprogram Changed:  ${{ steps.detect.outputs.miniprogram_changed }}"
                  echo ""
                  echo "💡 说明:"
                  echo "  - Console/Miniprogram Changed 已包含 Shared 的影响"
                  echo "  - 调用者可直接使用这些状态做测试/部署决策"

    # ====================================
    # 构建（与 Lint、单元测试并行）
    # ====================================
    build:
        name: 构建项目
        runs-on: ubuntu-latest
        needs: [detect-changes]
        steps:
            - name: 检出代码
              uses: actions/checkout@v4
              with:
                  ref: ${{ env.DEV_TAG }}

            - name: 安装 pnpm
              uses: pnpm/action-setup@v4

            - name: 设置 Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: 安装依赖
              run: pnpm install --frozen-lockfile

            - name: 构建项目
              run: pnpm build

            - name: 上传构建产物
              uses: actions/upload-artifact@v4
              with:
                  name: dist-files
                  path: dist/
                  retention-days: 1

    # ====================================
    # Lint（与构建、单元测试并行）
    # ====================================
    lint:
        name: 代码检查
        runs-on: ubuntu-latest
        needs: [detect-changes]
        steps:
            - name: 检出代码
              uses: actions/checkout@v4
              with:
                  ref: ${{ env.DEV_TAG }}

            - name: 安装 pnpm
              uses: pnpm/action-setup@v4

            - name: 设置 Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: 安装依赖
              run: pnpm install --frozen-lockfile

            - name: 代码检查
              run: pnpm lint

    # ====================================
    # 单元测试（与构建、Lint 并行）
    # ====================================
    unit-test:
        name: 单元测试
        runs-on: ubuntu-latest
        needs: [detect-changes]
        steps:
            - name: 检出代码
              uses: actions/checkout@v4
              with:
                  ref: ${{ env.DEV_TAG }}

            - name: 安装 pnpm
              uses: pnpm/action-setup@v4

            - name: 设置 Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: 安装依赖
              run: pnpm install --frozen-lockfile

            - name: 运行单元测试
              run: pnpm test

    # ====================================
    # Console E2E 测试（按需执行）
    # ====================================
    e2e-console:
        name: Console E2E 测试
        runs-on: ubuntu-latest
        needs: [detect-changes, build, lint, unit-test]
        if: needs.detect-changes.outputs.console_changed == 'true'
        steps:
            - name: 检出代码
              uses: actions/checkout@v4
              with:
                  ref: ${{ env.DEV_TAG }}

            - name: 安装 pnpm
              uses: pnpm/action-setup@v4

            - name: 设置 Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: 安装依赖
              run: pnpm install --frozen-lockfile

            - name: 运行 Console E2E 测试
              run: pnpm test:e2e:console

    # ====================================
    # Miniprogram E2E 测试（按需执行）
    # ====================================
    e2e-miniprogram:
        name: Miniprogram E2E 测试
        runs-on: ubuntu-latest
        needs: [detect-changes, build, lint, unit-test]
        if: needs.detect-changes.outputs.miniprogram_changed == 'true'
        steps:
            - name: 检出代码
              uses: actions/checkout@v4
              with:
                  ref: ${{ env.DEV_TAG }}

            - name: 安装 pnpm
              uses: pnpm/action-setup@v4

            - name: 设置 Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: 安装依赖
              run: pnpm install --frozen-lockfile

            - name: 运行 Miniprogram E2E 测试
              run: pnpm test:e2e:miniprogram

    # ====================================
    # 数据库迁移
    # ====================================
    migration-prod:
        name: 数据库迁移
        runs-on: ubuntu-latest
        needs:
            [
                detect-changes,
                build,
                lint,
                unit-test,
                e2e-console,
                e2e-miniprogram,
            ]
        if: |
            !contains(needs.*.result, 'failure') &&
            !contains(needs.*.result, 'cancelled')
        steps:
            - name: 检出代码
              uses: actions/checkout@v4
              with:
                  ref: ${{ env.DEV_TAG }}

            - name: 安装 pnpm
              uses: pnpm/action-setup@v4

            - name: 设置 Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: 安装依赖
              run: pnpm install --frozen-lockfile

            - name: 运行 migration
              run: pnpm migration run --prod
              env:
                  MIGRATION_DB_HOST: ${{ secrets.PROD_MIGRATION_DB_HOST }}
                  MIGRATION_DB_PORT: ${{ secrets.PROD_MIGRATION_DB_PORT }}
                  MIGRATION_DB_NAME: ${{ secrets.PROD_MIGRATION_DB_NAME }}
                  MIGRATION_DB_SCHEMA: ${{ secrets.PROD_MIGRATION_DB_SCHEMA }}
                  MIGRATION_USER: ${{ secrets.PROD_MIGRATION_USER }}
                  MIGRATION_PASSWORD: ${{ secrets.PROD_MIGRATION_PASSWORD }}

    # ====================================
    # 部署（复用构建产物）
    # ====================================
    deploy-prod:
        name: 部署生产
        runs-on: ubuntu-latest
        needs:
            [
                detect-changes,
                build,
                lint,
                unit-test,
                e2e-console,
                e2e-miniprogram,
                migration-prod,
            ]
        if: |
            (needs.detect-changes.outputs.console_changed == 'true' ||
             needs.detect-changes.outputs.miniprogram_changed == 'true' ||
             needs.detect-changes.outputs.layer_changed == 'true') &&
            !contains(needs.*.result, 'failure') &&
            !contains(needs.*.result, 'cancelled')
        environment:
            name: prod
            url: ${{ env.TENCENT_CONSOLE_URL }}
        steps:
            - name: 检出代码
              uses: actions/checkout@v4
              with:
                  ref: ${{ env.DEV_TAG }} # 从DEV环境当前版本部署
                  fetch-depth: 0 # 需要完整 git 历史（用于更新 tags）

            - name: 安装 pnpm
              uses: pnpm/action-setup@v4

            - name: 设置 Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'pnpm'

            - name: 安装依赖
              run: pnpm install --frozen-lockfile

            - name: 下载构建产物
              uses: actions/download-artifact@v4
              with:
                  name: dist-files
                  path: dist/
            - name: 确保 jq 已安装
              run: |
                  if ! command -v jq &> /dev/null; then
                      echo "安装 jq..."
                      sudo apt-get update && sudo apt-get install -y jq
                  else
                      echo "jq 已安装: $(jq --version)"
                  fi
            - name: 安装 SCF CLI
              run: |
                  # pnpm/action-setup@v4 已自动配置 PNPM_HOME，无需 pnpm setup
                  pnpm add -g serverless-cloud-framework@1.3.2
                  scf --version
            - name: 生产环境部署确认
              run: |
                  echo "⚠️  准备部署到生产环境 ⚠️"
                  echo ""
                  echo "部署信息:"
                  echo "  环境: PRODUCTION"
                  echo "  来源: ${{ env.DEV_TAG }} tag"
                  echo "  提交: $(git rev-parse ${{ env.DEV_TAG }})"
                  echo ""
                  echo "变更情况:"
                  echo "  Layer: ${{ needs.detect-changes.outputs.layer_changed }}"
                  echo "  Console: ${{ needs.detect-changes.outputs.console_changed }}"
                  echo "  Miniprogram: ${{ needs.detect-changes.outputs.miniprogram_changed }}"
                  echo ""
            - name: 检测变更并部署到生产环境
              run: |
                  echo "🚀 开始部署到生产环境..."
                  chmod +x ./deployment/ci-deploy.sh
                  ./deployment/ci-deploy.sh
              env:
                  STAGE: prod
                  SERVERLESS_PLATFORM_VENDOR: tencent # serverless 境外默认为 aws，配置为腾讯
                  # 传递变更检测结果，避免重复检测
                  LAYER_CHANGED: ${{ needs.detect-changes.outputs.layer_changed }}
                  CONSOLE_CHANGED: ${{ needs.detect-changes.outputs.console_changed }}
                  MINIPROGRAM_CHANGED: ${{ needs.detect-changes.outputs.miniprogram_changed }}
                  # 腾讯云凭证
                  TENCENT_SECRET_ID: ${{ secrets.PROD_TENCENT_SECRET_ID }}
                  TENCENT_SECRET_KEY: ${{ secrets.PROD_TENCENT_SECRET_KEY }}
                  # 区域配置
                  REGION: ap-chengdu
                  # Console 应用数据库配置
                  CONSOLE_DB_HOST: ${{ secrets.PROD_CONSOLE_DB_HOST }}
                  CONSOLE_DB_PORT: ${{ secrets.PROD_CONSOLE_DB_PORT }}
                  CONSOLE_DB_NAME: ${{ secrets.PROD_CONSOLE_DB_NAME }}
                  CONSOLE_DB_SCHEMA: ${{ secrets.PROD_CONSOLE_DB_SCHEMA }}
                  CONSOLE_DB_USER: ${{ secrets.PROD_CONSOLE_DB_USER }}
                  CONSOLE_DB_PASSWORD: ${{ secrets.PROD_CONSOLE_DB_PASSWORD }}
                  # Miniprogram 应用数据库配置
                  MINIPROGRAM_DB_HOST: ${{ secrets.PROD_MINIPROGRAM_DB_HOST }}
                  MINIPROGRAM_DB_PORT: ${{ secrets.PROD_MINIPROGRAM_DB_PORT }}
                  MINIPROGRAM_DB_NAME: ${{ secrets.PROD_MINIPROGRAM_DB_NAME }}
                  MINIPROGRAM_DB_SCHEMA: ${{ secrets.PROD_MINIPROGRAM_DB_SCHEMA }}
                  MINIPROGRAM_DB_USER: ${{ secrets.PROD_MINIPROGRAM_DB_USER }}
                  MINIPROGRAM_DB_PASSWORD: ${{ secrets.PROD_MINIPROGRAM_DB_PASSWORD }}

            - name: 更新生产部署标签
              run: |
                  DEPLOY_COMMIT=$(git rev-parse ${{ env.DEV_TAG }})

                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  # 如果不是首次部署，保存当前 prod-latest 为 prod-prev
                  if git rev-parse ${{ env.PROD_TAG }} >/dev/null 2>&1; then
                      PREV_COMMIT=$(git rev-parse ${{ env.PROD_TAG }})
                      git tag -f ${{ env.PROD_PREV_TAG }} $PREV_COMMIT -m "Previous production version (for rollback)

                      Commit: $PREV_COMMIT
                      Saved at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
                      git push -f origin ${{ env.PROD_PREV_TAG }}
                      echo "✅ ${{ env.PROD_PREV_TAG }} tag 已更新 → $PREV_COMMIT"
                  else
                      echo "ℹ️  首次部署，不创建 ${{ env.PROD_PREV_TAG }}"
                  fi

                  # 更新 prod-latest
                  git tag -f ${{ env.PROD_TAG }} -m "🚀 Deployed to PRODUCTION environment

                  From: ${{ env.DEV_TAG }}
                  Commit: $DEPLOY_COMMIT
                  Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
                  Deployed by: ${{ github.actor }}

                  Changes:
                  - Console: ${{ needs.detect-changes.outputs.console_changed }}
                  - Miniprogram: ${{ needs.detect-changes.outputs.miniprogram_changed }}
                  - Layer: ${{ needs.detect-changes.outputs.layer_changed }}"

                  git push -f origin ${{ env.PROD_TAG }}

                  echo "✅ 生产部署标签已更新: ${{ env.PROD_TAG }} → $DEPLOY_COMMIT"

            - name: 输出部署结果
              run: |
                  echo "🎉 生产环境部署完成！"
                  echo ""
                  echo "📊 部署摘要:"
                  echo "  来源: ${{ env.DEV_TAG }}"
                  echo "  Commit: $(git rev-parse ${{ env.DEV_TAG }})"
                  echo ""
                  echo "🏷️  Tags:"
                  echo "  ${{ env.PROD_TAG }} → $(git rev-parse ${{ env.PROD_TAG }})"
                  if git rev-parse ${{ env.PROD_PREV_TAG }} >/dev/null 2>&1; then
                      echo "  ${{ env.PROD_PREV_TAG }}   → $(git rev-parse ${{ env.PROD_PREV_TAG }}) (支持回滚)"
                  else
                      echo "  ${{ env.PROD_PREV_TAG }}   → (不存在，首次部署)"
                  fi
                  echo ""
                  echo "🔗 控制台: ${{ env.TENCENT_CONSOLE_URL }}"
                  echo ""
                  echo "⚠️  请验证生产环境功能是否正常"
