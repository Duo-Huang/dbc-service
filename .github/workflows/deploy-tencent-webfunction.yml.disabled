name: éƒ¨ç½²åˆ°è…¾è®¯äº‘ Web Function

# åŸºäºè…¾è®¯äº‘å®˜æ–¹æ–‡æ¡£ï¼šhttps://cloud.tencent.com/document/product/1154/59341
# ä½¿ç”¨ SCF Web Function ç›´æ¥è¿è¡Œ Nest.js åº”ç”¨

on:
    push:
        branches:
            - master
            - main
    pull_request:
        branches:
            - master
            - main

# é˜²æ­¢å¹¶å‘éƒ¨ç½²
concurrency:
    group: deploy-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # ====================================
    # ä»£ç æ£€æŸ¥ï¼ˆæ€»æ˜¯æ‰§è¡Œï¼‰
    # ====================================
    lint-and-test:
        name: ä»£ç æ£€æŸ¥å’Œæµ‹è¯•
        runs-on: ubuntu-latest
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'pnpm'

            - name: å®‰è£… pnpm
              run: npm install -g pnpm

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: ä»£ç æ£€æŸ¥
              run: pnpm lint

            - name: è¿è¡Œæµ‹è¯•
              run: pnpm test

    # ====================================
    # æ„å»ºå’Œéƒ¨ç½²
    # ====================================
    build-and-deploy:
        name: æ„å»ºå’Œéƒ¨ç½²
        runs-on: ubuntu-latest
        needs: lint-and-test
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'pnpm'

            - name: å®‰è£… pnpm
              run: npm install -g pnpm

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: æ„å»ºé¡¹ç›®
              run: pnpm build

            - name: å®‰è£… SCF CLI
              run: npm install -g @serverless/cli

            - name: é…ç½®è…¾è®¯äº‘å‡­è¯
              run: |
                  echo "é…ç½®è…¾è®¯äº‘å‡­è¯..."
                  # è¿™é‡Œéœ€è¦é…ç½®è…¾è®¯äº‘å‡­è¯
                  # export TENCENT_SECRET_ID=${{ secrets.TENCENT_SECRET_ID }}
                  # export TENCENT_SECRET_KEY=${{ secrets.TENCENT_SECRET_KEY }}

            - name: æ£€æµ‹å˜æ›´å¹¶éƒ¨ç½²
              run: |
                  echo "å¼€å§‹å˜æ›´æ£€æµ‹å’Œéƒ¨ç½²..."
                  ./deployment/ci-deploy.sh
              env:
                  # å¯ä»¥è®¾ç½®ç¯å¢ƒå˜é‡å¼ºåˆ¶æ„å»ºæ‰€æœ‰
                  # FORCE_BUILD: true

            - name: è¾“å‡ºéƒ¨ç½²ç»“æœ
              run: |
                  echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
                  echo "æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€: https://console.cloud.tencent.com/scf"
