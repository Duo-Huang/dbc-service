name: éƒ¨ç½²åˆ°è…¾è®¯äº‘ Web Function

# åŸºäºè…¾è®¯äº‘å®˜æ–¹æ–‡æ¡£ï¼šhttps://cloud.tencent.com/document/product/1154/59341
# ä½¿ç”¨ SCF Web Function ç›´æ¥è¿è¡Œ Nest.js åº”ç”¨

on:
    push:
        branches:
            - master
            - main
    pull_request:
        branches:
            - master
            - main

# é˜²æ­¢å¹¶å‘éƒ¨ç½²
concurrency:
    group: deploy-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # ====================================
    # æ£€æµ‹æ–‡ä»¶å˜æ›´
    # ====================================
    detect-changes:
        name: æ£€æµ‹æ–‡ä»¶å˜æ›´
        runs-on: ubuntu-latest
        outputs:
            console: ${{ steps.filter.outputs.console }}
            miniapp: ${{ steps.filter.outputs.miniapp }}
            shared: ${{ steps.filter.outputs.shared }}
            should_build: ${{ steps.decide.outputs.should_build }}
            should_deploy_console: ${{ steps.decide.outputs.deploy_console }}
            should_deploy_miniapp: ${{ steps.decide.outputs.deploy_miniapp }}
        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: æ£€æµ‹å˜æ›´æ–‡ä»¶
              uses: dorny/paths-filter@v3
              id: filter
              with:
                  filters: |
                      console:
                        - 'apps/console/**'
                      miniapp:
                        - 'apps/miniapp/**'
                      shared:
                        - 'libs/**'
                        - 'config/**'
                        - 'webpack.config.js'
                        - 'nest-cli.json'
                        - 'tsconfig*.json'
                        - 'package.json'
                        - 'pnpm-lock.yaml'
                        - 'deployment/**'

            - name: å†³ç­–éƒ¨ç½²ç­–ç•¥
              id: decide
              run: |
                  CONSOLE="${{ steps.filter.outputs.console }}"
                  MINIAPP="${{ steps.filter.outputs.miniapp }}"
                  SHARED="${{ steps.filter.outputs.shared }}"

                  echo "ğŸ“Š å˜æ›´æ£€æµ‹ç»“æœ:"
                  echo "  Console: $CONSOLE"
                  echo "  Miniapp: $MINIAPP"
                  echo "  Shared:  $SHARED"

                  # åˆ¤æ–­æ˜¯å¦éœ€è¦æ„å»º
                  if [[ "$CONSOLE" == "true" || "$MINIAPP" == "true" || "$SHARED" == "true" ]]; then
                    echo "should_build=true" >> $GITHUB_OUTPUT
                    echo "âœ… éœ€è¦æ„å»º"
                  else
                    echo "should_build=false" >> $GITHUB_OUTPUT
                    echo "â­ï¸  è·³è¿‡æ„å»ºï¼ˆä»…æ–‡æ¡£å˜æ›´ï¼‰"
                  fi

                  # åˆ¤æ–­ Console æ˜¯å¦éœ€è¦éƒ¨ç½²
                  if [[ "$CONSOLE" == "true" || "$SHARED" == "true" ]]; then
                    echo "deploy_console=true" >> $GITHUB_OUTPUT
                    echo "ğŸ“¦ Console éœ€è¦éƒ¨ç½²"
                  else
                    echo "deploy_console=false" >> $GITHUB_OUTPUT
                    echo "â­ï¸  Console è·³è¿‡éƒ¨ç½²"
                  fi

                  # åˆ¤æ–­ Miniapp æ˜¯å¦éœ€è¦éƒ¨ç½²
                  if [[ "$MINIAPP" == "true" || "$SHARED" == "true" ]]; then
                    echo "deploy_miniapp=true" >> $GITHUB_OUTPUT
                    echo "ğŸ“¦ Miniapp éœ€è¦éƒ¨ç½²"
                  else
                    echo "deploy_miniapp=false" >> $GITHUB_OUTPUT
                    echo "â­ï¸  Miniapp è·³è¿‡éƒ¨ç½²"
                  fi

    # ====================================
    # ä»£ç æ£€æŸ¥ï¼ˆæ€»æ˜¯æ‰§è¡Œï¼‰
    # ====================================
    lint:
        name: ä»£ç æ£€æŸ¥
        runs-on: ubuntu-latest

        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: å®‰è£… pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22.20.0'
                  cache: 'pnpm'

            - name: ç¼“å­˜ä¾èµ–
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.pnpm-store
                      node_modules
                  key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: æ‰§è¡Œ Lint æ£€æŸ¥
              run: pnpm lint

    # ====================================
    # å•å…ƒæµ‹è¯•ï¼ˆæ€»æ˜¯æ‰§è¡Œï¼‰
    # ====================================
    test:
        name: å•å…ƒæµ‹è¯•
        runs-on: ubuntu-latest

        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: å®‰è£… pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22.20.0'
                  cache: 'pnpm'

            - name: ç¼“å­˜ä¾èµ–
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.pnpm-store
                      node_modules
                  key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: æ‰§è¡Œæµ‹è¯•
              run: pnpm test

    # ====================================
    # æ„å»ºé¡¹ç›®ï¼ˆæ¡ä»¶æ‰§è¡Œï¼‰
    # ====================================
    build:
        name: æ„å»ºé¡¹ç›®
        runs-on: ubuntu-latest
        needs: [lint, test, detect-changes]
        if: needs.detect-changes.outputs.should_build == 'true'

        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: å®‰è£… pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22.20.0'
                  cache: 'pnpm'

            - name: ç¼“å­˜ä¾èµ–
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.pnpm-store
                      node_modules
                  key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --frozen-lockfile

            - name: æ„å»ºé¡¹ç›®
              run: pnpm build

            - name: ä¸Šä¼ æ„å»ºäº§ç‰©
              uses: actions/upload-artifact@v4
              with:
                  name: build-dist
                  path: dist/
                  retention-days: 1

    # ====================================
    # æ‰“åŒ… Console åº”ç”¨ï¼ˆæ¡ä»¶æ‰§è¡Œï¼‰
    # ====================================
    package-console:
        name: æ‰“åŒ… Console åº”ç”¨
        runs-on: ubuntu-latest
        needs: [build, detect-changes]
        if: needs.detect-changes.outputs.should_deploy_console == 'true'

        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: å®‰è£… pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22.20.0'
                  cache: 'pnpm'

            - name: ä¸‹è½½æ„å»ºäº§ç‰©
              uses: actions/download-artifact@v4
              with:
                  name: build-dist
                  path: dist/

            - name: è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
              run: chmod +x deployment/ci-deploy.sh

            - name: æ‰“åŒ… Console åº”ç”¨
              run: ./deployment/ci-deploy.sh console

            - name: æ£€æŸ¥éƒ¨ç½²åŒ…å¤§å°
              run: |
                  if [ -f "serverless_package/console.zip" ]; then
                    SIZE=$(du -m serverless_package/console.zip | cut -f1)
                    echo "ğŸ“¦ Console éƒ¨ç½²åŒ…å¤§å°: ${SIZE}MB"

                    if [ $SIZE -gt 50 ]; then
                      echo "âš ï¸  éƒ¨ç½²åŒ…è¶…è¿‡ 50MBï¼Œéœ€è¦é€šè¿‡ COS ä¸Šä¼ "
                      echo "   å‚è€ƒ: https://cloud.tencent.com/document/product/583/37940"
                    else
                      echo "âœ… éƒ¨ç½²åŒ…å¯ä»¥ç›´æ¥ä¸Šä¼ "
                    fi
                  fi

            - name: ä¸Šä¼  Console éƒ¨ç½²åŒ…
              uses: actions/upload-artifact@v4
              with:
                  name: console-package
                  path: serverless_package/console.zip
                  retention-days: 7

    # ====================================
    # æ‰“åŒ… Miniapp åº”ç”¨ï¼ˆæ¡ä»¶æ‰§è¡Œï¼‰
    # ====================================
    package-miniapp:
        name: æ‰“åŒ… Miniapp åº”ç”¨
        runs-on: ubuntu-latest
        needs: [build, detect-changes]
        if: needs.detect-changes.outputs.should_deploy_miniapp == 'true'

        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: å®‰è£… pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: è®¾ç½® Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22.20.0'
                  cache: 'pnpm'

            - name: ä¸‹è½½æ„å»ºäº§ç‰©
              uses: actions/download-artifact@v4
              with:
                  name: build-dist
                  path: dist/

            - name: è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
              run: chmod +x deployment/ci-deploy.sh

            - name: æ‰“åŒ… Miniapp åº”ç”¨
              run: ./deployment/ci-deploy.sh miniapp

            - name: æ£€æŸ¥éƒ¨ç½²åŒ…å¤§å°
              run: |
                  if [ -f "serverless_package/miniapp.zip" ]; then
                    SIZE=$(du -m serverless_package/miniapp.zip | cut -f1)
                    echo "ğŸ“¦ Miniapp éƒ¨ç½²åŒ…å¤§å°: ${SIZE}MB"

                    if [ $SIZE -gt 50 ]; then
                      echo "âš ï¸  éƒ¨ç½²åŒ…è¶…è¿‡ 50MBï¼Œéœ€è¦é€šè¿‡ COS ä¸Šä¼ "
                      echo "   å‚è€ƒ: https://cloud.tencent.com/document/product/583/37940"
                    else
                      echo "âœ… éƒ¨ç½²åŒ…å¯ä»¥ç›´æ¥ä¸Šä¼ "
                    fi
                  fi

            - name: ä¸Šä¼  Miniapp éƒ¨ç½²åŒ…
              uses: actions/upload-artifact@v4
              with:
                  name: miniapp-package
                  path: serverless_package/miniapp.zip
                  retention-days: 7

    # ====================================
    # éƒ¨ç½²è¯´æ˜
    # ====================================
    deploy-summary:
        name: éƒ¨ç½²è¯´æ˜
        runs-on: ubuntu-latest
        needs: [detect-changes, package-console, package-miniapp]
        if: |
            always() &&
            (needs.package-console.result == 'success' || needs.package-miniapp.result == 'success') &&
            (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')

        steps:
            - name: ä¸‹è½½ Console éƒ¨ç½²åŒ…
              if: needs.detect-changes.outputs.should_deploy_console == 'true'
              uses: actions/download-artifact@v4
              with:
                  name: console-package
                  path: packages/
              continue-on-error: true

            - name: ä¸‹è½½ Miniapp éƒ¨ç½²åŒ…
              if: needs.detect-changes.outputs.should_deploy_miniapp == 'true'
              uses: actions/download-artifact@v4
              with:
                  name: miniapp-package
                  path: packages/
              continue-on-error: true

            - name: æ˜¾ç¤ºéƒ¨ç½²åŒ…
              run: |
                  echo "ğŸ“¦ å¯ç”¨çš„éƒ¨ç½²åŒ…:"
                  ls -lh packages/ 2>/dev/null || echo "  (æ— éƒ¨ç½²åŒ…)"

            - name: éƒ¨ç½²è¯´æ˜
              run: |
                  echo "========================================"
                  echo "è…¾è®¯äº‘ Web Function éƒ¨ç½²åŒ…å·²å‡†å¤‡å®Œæˆ"
                  echo "========================================"
                  echo ""
                  echo "ğŸ“Š æœ¬æ¬¡æ„å»ºä¿¡æ¯:"
                  echo "  Console éƒ¨ç½²: ${{ needs.detect-changes.outputs.should_deploy_console }}"
                  echo "  Miniapp éƒ¨ç½²: ${{ needs.detect-changes.outputs.should_deploy_miniapp }}"
                  echo ""
                  echo "ğŸ“– å‚è€ƒæ–‡æ¡£:"
                  echo "  https://cloud.tencent.com/document/product/1154/59341"
                  echo ""
                  echo "ğŸ“¦ éƒ¨ç½²åŒ…åŒ…å«:"
                  echo "  âœ“ dist/ - æ„å»ºäº§ç‰©ï¼ˆwebpack æ‰“åŒ…ï¼‰"
                  echo "  âœ“ node_modules/ - ä»…ç”Ÿäº§ä¾èµ–"
                  echo "  âœ“ scf_bootstrap - Web Function å¯åŠ¨è„šæœ¬"
                  echo "  âœ“ package.json & pnpm-lock.yaml"
                  echo ""
                  echo "ğŸš€ éƒ¨ç½²æ–¹å¼ï¼š"
                  echo ""
                  echo "æ–¹å¼ 1: é€šè¿‡æ§åˆ¶å°éƒ¨ç½²ï¼ˆæ¨èï¼‰"
                  echo "  1. è®¿é—® https://console.cloud.tencent.com/sls"
                  echo "  2. æ–°å»ºåº”ç”¨ â†’ Web åº”ç”¨ â†’ Nest.js æ¡†æ¶"
                  echo "  3. ä¸Šä¼ æ–¹å¼é€‰æ‹©ã€Œæœ¬åœ°ä¸Šä¼ ã€"
                  echo "  4. ä» GitHub Actions Artifacts ä¸‹è½½å¯¹åº”çš„ zip åŒ…"
                  echo "  5. ä¸Šä¼ å¹¶å®Œæˆéƒ¨ç½²"
                  echo ""
                  echo "æ–¹å¼ 2: ä½¿ç”¨ Serverless CLIï¼ˆè‡ªåŠ¨åŒ–ï¼‰"
                  echo "  # ä¸‹è½½éƒ¨ç½²åŒ…å¹¶è§£å‹"
                  echo "  cd deployment/console"
                  echo "  serverless deploy --stage prod"
                  echo ""
                  echo "âš ï¸  æ³¨æ„äº‹é¡¹ï¼š"
                  echo "  â€¢ åº”ç”¨ç›‘å¬ 0.0.0.0:9000ï¼ˆWeb Function è¦æ±‚ï¼‰"
                  echo "  â€¢ scf_bootstrap å·²è®¾ç½®æ‰§è¡Œæƒé™"
                  echo "  â€¢ ä»…åŒ…å«ç”Ÿäº§ä¾èµ–ï¼ˆå‡å°åŒ…ä½“ç§¯ï¼‰"
                  echo "  â€¢ é…ç½®æ–‡ä»¶å·²åŒ…å«åœ¨æ„å»ºäº§ç‰©ä¸­"
                  echo ""
                  echo "âœ¨ ç‹¬ç«‹éƒ¨ç½²ä¼˜åŠ¿ï¼š"
                  echo "  â€¢ Console å’Œ Miniapp å¯ç‹¬ç«‹éƒ¨ç½²"
                  echo "  â€¢ ä¿®æ”¹å“ªä¸ªå°±éƒ¨ç½²å“ªä¸ªï¼ŒèŠ‚çœæ—¶é—´"
                  echo "  â€¢ å…±äº«åº“ï¼ˆlibs/ï¼‰æ”¹åŠ¨ä¼šè‡ªåŠ¨éƒ¨ç½²ä¸¤ä¸ªåº”ç”¨"
                  echo ""
                  echo "========================================"
